<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ø§Ù…Ø¹ â€” Two Manga</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
          colors: {
            brand: {
              dark: '#0f0f13',
              card: '#18181b',
              accent: '#8b5cf6',
              glow: '#d946ef'
            }
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'fade-in': 'fadeIn 0.3s ease-out forwards',
          },
          keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
          }
        }
      }
    };
  </script>

  <style>
    body { background-color: #0f0f13; color: #e4e4e7; scroll-behavior: smooth; }
    .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.15); }
    .nav-link.active { background: rgba(139, 92, 246, 0.1); border-right: 4px solid #8b5cf6; color: #8b5cf6; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
    #initial-loader { position: fixed; inset: 0; z-index: 100; background: #0f0f13; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  </style>
</head>
<body class="min-h-screen font-sans custom-scrollbar">

  <!-- Full Screen Auth Check Loader -->
  <div id="initial-loader">
    <div class="relative w-20 h-20 mb-6">
      <div class="absolute inset-0 border-4 border-brand-accent/20 rounded-full"></div>
      <div class="absolute inset-0 border-4 border-brand-accent border-t-transparent rounded-full animate-spin"></div>
    </div>
    <h2 class="text-xl font-bold text-white mb-2">Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ù‡ÙˆÛŒØª Ø§Ø¯Ù…ÛŒÙ†...</h2>
    <p class="text-gray-500 text-sm">Ø§ØªØµØ§Ù„ Ø¨Ù‡ https://two-api-iksq.onrender.com</p>
  </div>

  <div id="app-ui" class="opacity-0 transition-opacity duration-500 flex flex-col md:flex-row min-h-screen">
    
    <!-- Sidebar -->
    <aside class="w-full md:w-72 glass p-6 flex flex-col gap-8 z-20">
      <div class="flex items-center gap-4 px-2">
        <div class="w-12 h-12 bg-gradient-to-br from-brand-accent to-brand-glow rounded-2xl flex items-center justify-center shadow-lg shadow-brand-accent/30">
          <span class="text-2xl">âš¡</span>
        </div>
        <div>
          <h1 class="text-lg font-black text-white">TWO MANGA</h1>
          <p class="text-[10px] text-brand-accent tracking-widest font-bold">ADMIN PANEL v2.0</p>
        </div>
      </div>

      <nav class="flex-1 space-y-1">
        <p class="text-[10px] text-gray-500 font-bold px-4 mb-2 uppercase">Ø§ØµÙ„ÛŒ</p>
        <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-link w-full text-right p-3.5 rounded-xl transition-all hover:bg-white/5 flex items-center gap-3">
          <span class="opacity-70">ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ
        </button>
        
        <p class="text-[10px] text-gray-500 font-bold px-4 mb-2 mt-6 uppercase">Ù…Ø§Ù„ÛŒ Ùˆ ÙØ±ÙˆØ´</p>
        <button onclick="showTab('transactions')" id="nav-transactions" class="nav-link w-full text-right p-3.5 rounded-xl transition-all hover:bg-white/5 flex items-center gap-3 relative">
          <span class="opacity-70">ğŸ’³</span> ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
          <span id="pendingBadge" class="hidden absolute left-3 top-4 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
        </button>
        <button onclick="showTab('rates')" id="nav-rates" class="nav-link w-full text-right p-3.5 rounded-xl transition-all hover:bg-white/5 flex items-center gap-3">
          <span class="opacity-70">ğŸ’°</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ø±Ø® Ø§Ø±Ø²
        </button>

        <p class="text-[10px] text-gray-500 font-bold px-4 mb-2 mt-6 uppercase">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
        <button onclick="showTab('users')" id="nav-users" class="nav-link w-full text-right p-3.5 rounded-xl transition-all hover:bg-white/5 flex items-center gap-3">
          <span class="opacity-70">ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        </button>
      </nav>

      <div class="p-4 rounded-2xl bg-white/5 border border-white/10 space-y-3">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-brand-accent/20 flex items-center justify-center text-brand-accent text-sm font-bold" id="adminInitial">A</div>
          <div class="flex-1 min-w-0">
            <p id="adminUserDisplay" class="text-sm font-bold truncate text-white"></p>
            <p class="text-[10px] text-gray-400">Ø³Ø·Ø­: Ù…Ø¯ÛŒØ± Ø§Ø±Ø´Ø¯</p>
          </div>
        </div>
        <button onclick="logout()" class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg text-xs font-bold transition-colors">
          Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-8 space-y-8 max-h-screen overflow-y-auto custom-scrollbar">
      
      <!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content">
        <header class="mb-8">
          <h2 class="text-3xl font-black text-white">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h2>
          <p class="text-gray-500 mt-1">Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ… Ø¯Ø± ÛŒÚ© Ù†Ú¯Ø§Ù‡</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="glass p-6 rounded-3xl relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 w-20 h-20 bg-brand-accent/10 rounded-full blur-2xl group-hover:bg-brand-accent/20 transition-all"></div>
            <p class="text-gray-400 text-sm">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú©Ù„</p>
            <h3 id="stat-total-users" class="text-3xl font-black mt-2 text-white">---</h3>
          </div>
          <div class="glass p-6 rounded-3xl relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 w-20 h-20 bg-green-500/10 rounded-full blur-2xl group-hover:bg-green-500/20 transition-all"></div>
            <p class="text-gray-400 text-sm">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚</p>
            <h3 id="stat-total-paid" class="text-3xl font-black mt-2 text-white">---</h3>
          </div>
          <div class="glass p-6 rounded-3xl relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 w-20 h-20 bg-yellow-500/10 rounded-full blur-2xl group-hover:bg-yellow-500/20 transition-all"></div>
            <p class="text-gray-400 text-sm">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</p>
            <h3 id="stat-pending-tx" class="text-3xl font-black mt-2 text-white">---</h3>
          </div>
          <div class="glass p-6 rounded-3xl border-brand-accent/30 shadow-lg shadow-brand-accent/5">
            <p class="text-brand-accent text-sm font-bold">ÙˆØ¶Ø¹ÛŒØª API</p>
            <div class="flex items-center gap-2 mt-2">
              <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
              <span id="backendUrl" class="text-xs font-mono opacity-60"></span>
            </div>
          </div>
        </div>

        <div class="mt-8 glass p-8 rounded-3xl">
          <div class="flex justify-between items-center mb-6">
            <h4 class="text-xl font-bold">Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</h4>
            <button onclick="loadDashboardStats()" class="text-brand-accent text-sm hover:underline">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-right">
              <thead>
                <tr class="text-gray-500 text-sm border-b border-white/5">
                  <th class="pb-4 pr-4">Ú©Ø§Ø±Ø¨Ø±</th>
                  <th class="pb-4">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</th>
                  <th class="pb-4">Ù†ÙˆØ¹ Ø§Ø´ØªØ±Ø§Ú©</th>
                  <th class="pb-4">ÙˆØ¶Ø¹ÛŒØª</th>
                </tr>
              </thead>
              <tbody id="dashboard-tx-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Transactions Tab -->
      <div id="tab-transactions" class="tab-content">
        <header class="mb-8 flex justify-between items-end">
          <div>
            <h2 class="text-3xl font-black text-white">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h2>
            <p class="text-gray-500 mt-1">ØªØ§ÛŒÛŒØ¯ ÛŒØ§ Ø±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
          </div>
          <button onclick="loadTransactions()" class="px-6 py-2 bg-brand-accent rounded-xl font-bold text-sm">Ø±ÙØ±Ø´ Ù„ÛŒØ³Øª</button>
        </header>

        <div class="glass rounded-3xl overflow-hidden">
          <table class="w-full text-right border-collapse">
            <thead class="bg-white/5 text-gray-400 text-sm font-bold">
              <tr>
                <th class="p-5">Ú©Ø§Ø±Ø¨Ø± / Ø²Ù…Ø§Ù†</th>
                <th class="p-5">Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</th>
                <th class="p-5">Ù…Ø¨Ù„Øº / Ù¾Ù„Ù†</th>
                <th class="p-5 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="transactions-list" class="divide-y divide-white/5"></tbody>
          </table>
        </div>
      </div>

      <!-- Rates Tab -->
      <div id="tab-rates" class="tab-content">
        <h2 class="text-3xl font-black text-white mb-8">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ø±Ø® Ø§Ø±Ø²</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="glass p-8 rounded-3xl space-y-6">
            <h4 class="text-xl font-bold text-brand-accent flex items-center gap-2">
              <span>ğŸ”„</span> Ø¢Ù¾Ø¯ÛŒØª Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©
            </h4>
            <p class="text-gray-400 text-sm leading-relaxed">Ø¨Ø§ ÙØ´Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ±ØŒ Ø³ÛŒØ³ØªÙ… Ø§Ø² Ø·Ø±ÛŒÙ‚ API Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡ Ùˆ Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
            <button id="btnFetchRates" onclick="fetchRates()" class="w-full py-4 bg-gradient-to-r from-brand-accent to-brand-glow rounded-2xl font-black text-white shadow-xl shadow-brand-accent/20 transition-all hover:scale-[1.02] active:scale-95">
              ÙÚ† Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
            </button>
            <p id="ratesMsg" class="text-center text-xs text-gray-500 font-mono"></p>
          </div>

          <div class="glass p-8 rounded-3xl flex items-center justify-center border-dashed border-2 border-white/10 text-gray-500">
             Ø¨Ø®Ø´ ØªØºÛŒÛŒØ± Ø¯Ø³ØªÛŒ Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="tab-users" class="tab-content">
        <h2 class="text-3xl font-black text-white mb-8">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
        <div class="glass rounded-3xl overflow-hidden">
          <div class="p-6 border-b border-white/5 flex gap-4">
            <input type="text" id="userSearchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ..." class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-brand-accent transition-all">
            <button onclick="loadUsers()" class="px-6 py-2 bg-white/10 rounded-xl hover:bg-white/20 transition-all text-sm font-bold">Ø¬Ø³ØªØ¬Ùˆ</button>
          </div>
          <table class="w-full text-right">
            <thead class="bg-white/5 text-gray-400 text-sm font-bold">
              <tr>
                <th class="p-5">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
                <th class="p-5">ÙˆØ¶Ø¹ÛŒØª Ù†Ù‚Ø´</th>
                <th class="p-5">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</th>
                <th class="p-5 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="users-list" class="divide-y divide-white/5"></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <script>
    // ØªÙ†Ø¸ÛŒÙ… Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚ Ø¨Ú©â€ŒÙ†Ø¯
    const BACKEND = "https://two-api-iksq.onrender.com";
    const AUTH_PAGE = "/auth/";
    const USER_PANEL = "/panel/";

    function getStoredToken() { return localStorage.getItem("access_token"); }

    function authHeaders() {
      return {
        "Authorization": "Bearer " + getStoredToken(),
        "Content-Type": "application/json",
        "Accept": "application/json"
      };
    }

    // --- Core: Bootstrap & Strict Role Check ---
    async function bootstrap() {
      const token = getStoredToken();
      if (!token) {
        window.location.href = AUTH_PAGE;
        return;
      }

      try {
        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Ø±ÙˆØª /auth/me Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø¯ÛŒØªØ§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ø±Ø¨Ø±
        const res = await fetch(`${BACKEND}/auth/me`, {
          method: "GET",
          headers: authHeaders()
        });

        if (!res.ok) {
           throw new Error("Token Invalid or Expired");
        }

        const userData = await res.json();

        // Ú†Ú© Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´ (Role) - ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ø§Ø¬Ø§Ø²Ù‡ ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø±Ø¯
        if (userData.role !== "admin") {
          console.warn("Access Denied: User is not an admin", userData);
          alert("Ø®Ø·Ø§: Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø¯Ø§Ø±ÛŒØ¯.");
          window.location.href = USER_PANEL; // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ
          return;
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
        document.getElementById("adminUserDisplay").innerText = userData.username;
        document.getElementById("adminInitial").innerText = userData.username[0].toUpperCase();
        document.getElementById("backendUrl").innerText = BACKEND;
        
        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯Ø± Ùˆ Ù†Ù…Ø§ÛŒØ´ UI Ø§ØµÙ„ÛŒ
        const loader = document.getElementById("initial-loader");
        loader.classList.add("opacity-0");
        setTimeout(() => {
          loader.style.display = "none";
          document.getElementById("app-ui").classList.remove("opacity-0");
        }, 500);

        // Ø§Ø¬Ø±Ø§ÛŒ Ø¯ÛŒØªØ§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        showTab('dashboard');

      } catch (err) {
        console.error("Auth Fail:", err);
        localStorage.removeItem("access_token");
        window.location.href = AUTH_PAGE;
      }
    }

    // --- Navigation ---
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      
      document.getElementById('tab-' + tabId).classList.add('active');
      document.getElementById('nav-' + tabId).classList.add('active');

      if(tabId === 'transactions') loadTransactions();
      if(tabId === 'users') loadUsers();
      if(tabId === 'dashboard') loadDashboardStats();
    }

    // --- Dashboard Stats ---
    async function loadDashboardStats() {
      try {
        const res = await fetch(`${BACKEND}/admin/users`, { headers: authHeaders() });
        const usersData = await res.json();
        
        const txRes = await fetch(`${BACKEND}/admin/transactions`, { headers: authHeaders() });
        const txData = await txRes.json();

        if (res.ok && txRes.ok) {
          const users = usersData.users || [];
          const txs = txData.transactions || [];
          
          document.getElementById("stat-total-users").innerText = users.length;
          document.getElementById("stat-total-paid").innerText = txs.filter(t => t.status === 'paid').length;
          const pendingCount = txs.filter(t => t.status === 'pending').length;
          document.getElementById("stat-pending-tx").innerText = pendingCount;
          
          const badge = document.getElementById("pendingBadge");
          if(pendingCount > 0) badge.classList.remove('hidden');
          else badge.classList.add('hidden');

          const tbody = document.getElementById("dashboard-tx-table");
          tbody.innerHTML = txs.slice(0, 5).map(t => `
            <tr class="text-sm border-b border-white/5 hover:bg-white/5 transition-colors">
              <td class="py-4 pr-4 font-bold text-white">${t.username}</td>
              <td class="py-4">${Number(t.amount).toLocaleString()}</td>
              <td class="py-4 text-xs text-gray-400">${t.plan_id}</td>
              <td class="py-4">
                <span class="px-2 py-1 rounded-full text-[10px] ${t.status === 'paid' ? 'bg-green-500/20 text-green-500' : 'bg-yellow-500/20 text-yellow-500'}">
                  ${t.status === 'paid' ? 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡' : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±'}
                </span>
              </td>
            </tr>
          `).join('');
        }
      } catch (err) { console.error(err); }
    }

    // --- Transactions Management ---
    async function loadTransactions() {
      const tbody = document.getElementById("transactions-list");
      tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ù„ÙˆØ¯...</td></tr>';
      
      try {
        const res = await fetch(`${BACKEND}/admin/transactions`, { headers: authHeaders() });
        const data = await res.json();
        
        if (res.ok) {
          const list = data.transactions || [];
          if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center opacity-40">ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
            return;
          }
          
          tbody.innerHTML = list.reverse().map(t => `
            <tr class="hover:bg-white/[0.02] transition-colors">
              <td class="p-5">
                <div class="font-bold text-white">${t.username}</div>
                <div class="text-[10px] text-gray-500 mt-1">${new Date(t.created_at).toLocaleString('fa-IR')}</div>
              </td>
              <td class="p-5 font-mono text-xs text-brand-accent">${t.ref_id || 'N/A'}</td>
              <td class="p-5">
                <div class="text-sm">${Number(t.amount).toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                <div class="text-[10px] text-gray-500">${t.plan_id}</div>
              </td>
              <td class="p-5">
                ${t.status === 'pending' ? `
                  <div class="flex justify-center gap-2">
                    <button onclick="updateTx('${t._id}', 'approve')" class="px-4 py-1.5 bg-green-500/10 hover:bg-green-500 text-green-500 hover:text-white rounded-lg text-xs font-bold transition-all">ØªØ§ÛŒÛŒØ¯</button>
                    <button onclick="updateTx('${t._id}', 'reject')" class="px-4 py-1.5 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-lg text-xs font-bold transition-all">Ø±Ø¯</button>
                  </div>
                ` : `
                  <div class="text-center text-[10px] uppercase font-bold ${t.status === 'paid' ? 'text-green-500' : 'text-red-500'}">
                    ${t.status === 'paid' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡' : 'Ø±Ø¯ Ø´Ø¯Ù‡'}
                  </div>
                `}
              </td>
            </tr>
          `).join('');
        }
      } catch (err) { tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-red-500">Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡</td></tr>'; }
    }

    async function updateTx(txId, action) {
      if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø§Ù†Ø¬Ø§Ù… Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø±ÙˆÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
      try {
        const res = await fetch(`${BACKEND}/admin/transactions/${txId}/${action}`, {
          method: "POST",
          headers: authHeaders()
        });
        if(res.ok) {
          alert("Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
          loadTransactions();
          loadDashboardStats();
        } else {
          const err = await res.json();
          alert("Ø®Ø·Ø§: " + err.msg);
        }
      } catch (err) { alert("Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±"); }
    }

    // --- Rates ---
    async function fetchRates() {
      const btn = document.getElementById("btnFetchRates");
      const msg = document.getElementById("ratesMsg");
      btn.disabled = true;
      msg.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§...";
      
      try {
        const res = await fetch(`${BACKEND}/admin/fetch-rates`, {
          method: "POST",
          headers: authHeaders()
        });
        if(res.ok) {
          msg.className = "text-center text-xs text-green-500 font-bold";
          msg.innerText = "âœ… Ù†Ø±Ø®â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯Ù†Ø¯.";
          setTimeout(() => { msg.innerText = ""; btn.disabled = false; }, 3000);
        } else {
          msg.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ù†Ø±Ø®â€ŒÙ‡Ø§";
          btn.disabled = false;
        }
      } catch (e) {
        msg.innerText = "âš ï¸ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡";
        btn.disabled = false;
      }
    }

    // --- Users ---
    async function loadUsers() {
      const tbody = document.getElementById("users-list");
      tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center animate-pulse">Ø¯Ø± Ø­Ø§Ù„ ÙÚ† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...</td></tr>';
      try {
        const res = await fetch(`${BACKEND}/admin/users`, { headers: authHeaders() });
        const data = await res.json();
        if(res.ok) {
          let list = data.users || [];
          const search = document.getElementById("userSearchInput").value.toLowerCase();
          if(search) list = list.filter(u => u.username.toLowerCase().includes(search));

          tbody.innerHTML = list.map(u => `
            <tr class="hover:bg-white/[0.02]">
              <td class="p-5 font-bold text-white">${u.username}</td>
              <td class="p-5">
                <span class="px-2 py-0.5 rounded-full text-[10px] ${u.role === 'admin' ? 'bg-brand-accent/20 text-brand-accent' : 'bg-white/10 text-gray-400'}">
                  ${u.role}
                </span>
              </td>
              <td class="p-5 text-sm text-gray-500 font-mono">${u.expiryDate ? new Date(u.expiryDate).toLocaleDateString('fa-IR') : 'Ø¯Ø§Ø¦Ù… / Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
              <td class="p-5 text-center">
                <button class="text-xs text-brand-accent hover:underline">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªØ±Ø³ÛŒ</button>
              </td>
            </tr>
          `).join('');
        }
      } catch (err) { tbody.innerHTML = '<tr><td colspan="4" class="p-5 text-red-500 text-center">Ø®Ø·Ø§</td></tr>'; }
    }

    function logout() {
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = AUTH_PAGE;
    }

    // Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
    window.onload = bootstrap;
  </script>
</body>
</html>
