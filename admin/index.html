<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø¯ÛŒØ±ÛŒØª Two Manga â€” Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
          colors: {
            brand: {
              dark: '#0f0f13',
              card: '#18181b',
              accent: '#8b5cf6',
              glow: '#d946ef'
            }
          }
        }
      }
    };
  </script>

  <style>
    body { background-color: #0f0f13; color: #e4e4e7; overflow-x: hidden; }
    .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.15); }
    .nav-link.active { background: rgba(139, 92, 246, 0.1); border-right: 4px solid #8b5cf6; color: #8b5cf6; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    #access-denied-screen { display: none; }
    #initial-loader { position: fixed; inset: 0; z-index: 100; background: #0f0f13; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  </style>
</head>
<body class="min-h-screen font-sans custom-scrollbar">

  <!-- Loading Screen -->
  <div id="initial-loader">
    <div class="w-16 h-16 border-4 border-brand-accent border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="text-gray-400 animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ù…Ø§...</p>
  </div>

  <!-- Access Denied Screen (No Redirect) -->
  <div id="access-denied-screen" class="fixed inset-0 z-[110] bg-brand-dark flex items-center justify-center p-6 text-center">
    <div class="max-w-md w-full glass p-10 rounded-[2.5rem] border-red-500/30">
      <div class="w-20 h-20 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center text-4xl mx-auto mb-6">âš ï¸</div>
      <h2 class="text-2xl font-black text-white mb-4">Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„</h2>
      <p id="denied-msg" class="text-gray-400 mb-8 leading-relaxed">Ù…ØªØ§Ø³ÙÛŒÙ…ØŒ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ "Ø§Ø¯Ù…ÛŒÙ†" Ù†Ø¯Ø§Ø±Ø¯ Ùˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø´ÙˆÛŒØ¯.</p>
      <a href="/" class="inline-block w-full py-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl font-bold transition-all">Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø³Ø§ÛŒØª</a>
    </div>
  </div>

  <!-- UI Wrapper -->
  <div id="app-ui" class="hidden flex flex-col md:flex-row min-h-screen">
    
    <!-- Sidebar -->
    <aside class="w-full md:w-72 glass p-6 flex flex-col gap-8">
      <div class="flex items-center gap-4 px-2">
        <div class="w-12 h-12 bg-gradient-to-br from-brand-accent to-brand-glow rounded-2xl flex items-center justify-center shadow-lg">
          <span class="text-2xl">âš¡</span>
        </div>
        <div>
          <h1 class="text-lg font-black text-white">TWO MANGA</h1>
          <p class="text-[10px] text-brand-accent font-bold tracking-widest uppercase">Admin System</p>
        </div>
      </div>

      <nav class="flex-1 space-y-2">
        <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-link w-full text-right p-3.5 rounded-xl transition-all flex items-center gap-3 active">
          <span class="opacity-70">ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ
        </button>
        <button onclick="showTab('transactions')" id="nav-transactions" class="nav-link w-full text-right p-3.5 rounded-xl transition-all flex items-center gap-3 relative">
          <span class="opacity-70">ğŸ’³</span> ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
          <span id="pendingBadge" class="hidden absolute left-3 top-4 w-2 h-2 bg-red-500 rounded-full"></span>
        </button>
        <button onclick="showTab('rates')" id="nav-rates" class="nav-link w-full text-right p-3.5 rounded-xl transition-all flex items-center gap-3">
          <span class="opacity-70">ğŸ’°</span> Ù†Ø±Ø® Ø§Ø±Ø² Ùˆ Ù¾Ù„Ù†â€ŒÙ‡Ø§
        </button>
        <button onclick="showTab('users')" id="nav-users" class="nav-link w-full text-right p-3.5 rounded-xl transition-all flex items-center gap-3">
          <span class="opacity-70">ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        </button>
      </nav>

      <div class="p-4 rounded-2xl bg-white/5 border border-white/10">
        <div class="flex items-center gap-3 mb-4">
          <div id="adminInitials" class="w-10 h-10 rounded-full bg-brand-accent/20 flex items-center justify-center font-bold text-brand-accent">?</div>
          <div class="flex-1 min-w-0">
            <p id="adminName" class="text-sm font-bold truncate">Ù†Ø§Ù… Ù…Ø¯ÛŒØ±</p>
            <p class="text-[10px] text-green-500">Ø§Ø¯Ù…ÛŒÙ† ÙØ¹Ø§Ù„</p>
          </div>
        </div>
        <button onclick="logout()" class="w-full py-2 bg-red-500/10 text-red-500 rounded-lg text-xs font-bold hover:bg-red-500/20 transition-all">Ø®Ø±ÙˆØ¬</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-10 space-y-8 max-h-screen overflow-y-auto custom-scrollbar">
      
      <!-- Dashboard -->
      <div id="tab-dashboard" class="tab-content active">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
          <div class="glass p-8 rounded-[2rem]">
            <p class="text-gray-400 text-sm">Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
            <h3 id="dash-users" class="text-4xl font-black mt-2">---</h3>
          </div>
          <div class="glass p-8 rounded-[2rem]">
            <p class="text-gray-400 text-sm">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚</p>
            <h3 id="dash-paid" class="text-4xl font-black mt-2 text-green-500">---</h3>
          </div>
          <div class="glass p-8 rounded-[2rem]">
            <p class="text-gray-400 text-sm">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</p>
            <h3 id="dash-pending" class="text-4xl font-black mt-2 text-yellow-500">---</h3>
          </div>
        </div>
        <div class="glass p-8 rounded-[2rem]">
            <h4 class="text-xl font-bold mb-6">ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±</h4>
            <p id="serverStatus" class="text-xs font-mono opacity-50">Ø¯Ø± Ø­Ø§Ù„ Ú†Ú©...</p>
        </div>
      </div>

      <!-- Transactions -->
      <div id="tab-transactions" class="tab-content">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-black">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h2>
            <button onclick="loadTransactions()" class="px-5 py-2 bg-brand-accent rounded-xl text-sm font-bold">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª</button>
        </div>
        <div class="glass rounded-3xl overflow-hidden">
          <table class="w-full text-right border-collapse">
            <thead class="bg-white/5 text-gray-400 text-xs">
              <tr>
                <th class="p-5">Ú©Ø§Ø±Ø¨Ø±</th>
                <th class="p-5">Ù…Ø¨Ù„Øº / Ø²Ù…Ø§Ù†</th>
                <th class="p-5">Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</th>
                <th class="p-5 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="tx-list" class="divide-y divide-white/5 text-sm"></tbody>
          </table>
        </div>
      </div>

      <!-- Rates -->
      <div id="tab-rates" class="tab-content">
        <h2 class="text-3xl font-black mb-8">Ù†Ø±Ø® Ø§Ø±Ø²</h2>
        <div class="max-w-xl glass p-8 rounded-[2rem] space-y-6">
            <p class="text-gray-400">Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± Ø±Ø§ Ø§Ø² APIÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ ÙÚ† Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø´Ù…Ø§ Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ù¾Ù„Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
            <button id="rateBtn" onclick="updateRates()" class="w-full py-4 bg-brand-accent rounded-2xl font-bold shadow-lg shadow-brand-accent/30">Ø´Ø±ÙˆØ¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø±Ø® Ø§Ø±Ø²</button>
            <div id="rateStatus" class="text-center text-sm font-bold"></div>
        </div>
      </div>

      <!-- Users -->
      <div id="tab-users" class="tab-content">
        <h2 class="text-3xl font-black mb-8">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
        <div class="glass rounded-3xl overflow-hidden">
          <table class="w-full text-right">
            <thead class="bg-white/5 text-xs text-gray-400">
              <tr>
                <th class="p-5">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
                <th class="p-5">Ù†Ù‚Ø´</th>
                <th class="p-5">Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ø´ØªØ±Ø§Ú©</th>
                <th class="p-5">Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="user-list" class="divide-y divide-white/5 text-sm"></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <script>
    const API_URL = "https://two-api-iksq.onrender.com";
    
    function getToken() { return localStorage.getItem("access_token"); }
    function getHeaders() {
      return {
        "Authorization": "Bearer " + getToken(),
        "Content-Type": "application/json",
        "Accept": "application/json"
      };
    }

    // --- Bootstrap: Strict Check ---
    async function bootstrap() {
      const token = getToken();
      if (!token) {
          showError("Ø´Ù…Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ø§Ø¨ØªØ¯Ø§ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯.");
          return;
      }

      try {
        // ÙÚ† Ú©Ø±Ø¯Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø¯ÛŒØªØ§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Role
        const res = await fetch(`${API_URL}/auth/me`, {
          method: "GET",
          headers: getHeaders()
        });

        if (!res.ok) {
           throw new Error("Invalid Token");
        }

        const user = await res.json();

        // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‚Ø´ Ø§Ø¯Ù…ÛŒÙ†
        if (user.role !== "admin") {
          showError(`Ø´Ù…Ø§ Ø¨Ø§ Ù†Ù‚Ø´ "${user.role}" ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù…Ø¬Ø§Ø² Ø§Ø³Øª.`);
          return;
        }

        // Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² - Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„
        document.getElementById("adminName").innerText = user.username;
        document.getElementById("adminInitials").innerText = user.username[0].toUpperCase();
        document.getElementById("serverStatus").innerText = "Ù…ØªØµÙ„ Ø¨Ù‡: " + API_URL;
        
        document.getElementById("initial-loader").style.display = "none";
        document.getElementById("app-ui").classList.remove("hidden");
        
        loadDashboard();

      } catch (err) {
        showError("Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ù‡ÙˆÛŒØª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.");
      }
    }

    function showError(msg) {
        document.getElementById("initial-loader").style.display = "none";
        document.getElementById("denied-msg").innerText = msg;
        document.getElementById("access-denied-screen").style.display = "flex";
    }

    // --- Tab Management ---
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
      document.getElementById('nav-' + tabId).classList.add('active');
      
      if(tabId === 'dashboard') loadDashboard();
      if(tabId === 'transactions') loadTransactions();
      if(tabId === 'users') loadUsers();
    }

    // --- Dashboard ---
    async function loadDashboard() {
        try {
            const uRes = await fetch(`${API_URL}/admin/users`, { headers: getHeaders() });
            const tRes = await fetch(`${API_URL}/admin/transactions`, { headers: getHeaders() });
            if(uRes.ok && tRes.ok) {
                const ud = await uRes.json();
                const td = await tRes.json();
                document.getElementById("dash-users").innerText = ud.users.length;
                document.getElementById("dash-paid").innerText = td.transactions.filter(x => x.status === 'paid').length;
                const p = td.transactions.filter(x => x.status === 'pending').length;
                document.getElementById("dash-pending").innerText = p;
                
                if(p > 0) document.getElementById("pendingBadge").classList.remove('hidden');
            }
        } catch (e) {}
    }

    // --- Transactions ---
    async function loadTransactions() {
        const list = document.getElementById("tx-list");
        list.innerHTML = '<tr><td colspan="4" class="p-10 text-center opacity-50">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>';
        try {
            const res = await fetch(`${API_URL}/admin/transactions`, { headers: getHeaders() });
            const data = await res.json();
            if(res.ok) {
                list.innerHTML = data.transactions.reverse().map(t => `
                    <tr class="hover:bg-white/5 transition-all">
                        <td class="p-5 font-bold">${t.username}</td>
                        <td class="p-5">
                            <div>${Number(t.amount).toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                            <div class="text-[10px] text-gray-500">${new Date(t.created_at).toLocaleString('fa-IR')}</div>
                        </td>
                        <td class="p-5 font-mono text-brand-accent">${t.ref_id || '---'}</td>
                        <td class="p-5 text-center">
                            ${t.status === 'pending' ? `
                                <button onclick="txOp('${t._id}', 'approve')" class="px-3 py-1 bg-green-500/20 text-green-500 rounded-lg text-xs ml-2 hover:bg-green-500 hover:text-white transition-all">ØªØ§ÛŒÛŒØ¯</button>
                                <button onclick="txOp('${t._id}', 'reject')" class="px-3 py-1 bg-red-500/20 text-red-500 rounded-lg text-xs hover:bg-red-500 hover:text-white transition-all">Ø±Ø¯</button>
                            ` : `<span class="text-[10px] font-bold uppercase ${t.status === 'paid' ? 'text-green-500' : 'text-red-500'}">${t.status}</span>`}
                        </td>
                    </tr>
                `).join('');
            }
        } catch (e) { list.innerHTML = 'Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡'; }
    }

    async function txOp(id, act) {
        if(!confirm("Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
        try {
            const res = await fetch(`${API_URL}/admin/transactions/${id}/${act}`, { method: 'POST', headers: getHeaders() });
            if(res.ok) { alert("Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"); loadTransactions(); }
        } catch (e) { alert("Ø®Ø·Ø§"); }
    }

    // --- Rates ---
    async function updateRates() {
        const btn = document.getElementById("rateBtn");
        const st = document.getElementById("rateStatus");
        btn.disabled = true;
        st.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª...";
        try {
            const res = await fetch(`${API_URL}/admin/fetch-rates`, { method: 'POST', headers: getHeaders() });
            if(res.ok) { st.innerText = "âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯."; }
            else { st.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø±ÙˆØ±"; }
        } catch (e) { st.innerText = "âš ï¸ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"; }
        btn.disabled = false;
    }

    // --- Users ---
    async function loadUsers() {
        const list = document.getElementById("user-list");
        try {
            const res = await fetch(`${API_URL}/admin/users`, { headers: getHeaders() });
            const data = await res.json();
            if(res.ok) {
                list.innerHTML = data.users.map(u => `
                    <tr class="hover:bg-white/5">
                        <td class="p-5 font-bold">${u.username}</td>
                        <td class="p-5"><span class="px-2 py-0.5 bg-white/10 rounded-full text-[10px]">${u.role}</span></td>
                        <td class="p-5 text-xs text-gray-400">${u.expiryDate ? new Date(u.expiryDate).toLocaleDateString('fa-IR') : '---'}</td>
                        <td class="p-5"><button class="text-brand-accent text-xs">ÙˆÛŒØ±Ø§ÛŒØ´</button></td>
                    </tr>
                `).join('');
            }
        } catch (e) {}
    }

    function logout() {
        localStorage.clear();
        window.location.href = "/auth/";
    }

    // Start checking on load
    window.onload = bootstrap;
  </script>
</body>
</html>
