<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>پنل ادمین — Two Manga</title>

  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['Vazirmatn','sans-serif'] } } }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
  <style>
    body { background:#050505;color:#f4f4f5;font-family:Vazirmatn,system-ui; }
    .glass { background: rgba(24,24,27,0.62); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.06); }
    .loader{border:3px solid rgba(255,255,255,0.1);border-left-color:#8b5cf6;border-radius:50%;width:22px;height:22px;animation:spin 1s linear infinite}
    @keyframes spin {to{transform:rotate(360deg)}}
    .access-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:60;padding:20px}
    .card{width:100%;max-width:760px;padding:18px;border-radius:12px}
    .mono{font-family:ui-monospace,Roboto Mono,monospace}
    .small-muted{color:rgba(255,255,255,0.6);font-size:0.9rem}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- App root (hidden until auth/me ok) -->
  <div id="appRoot" class="max-w-7xl mx-auto px-4 py-6 hidden">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#7c3aed] to-[#d946ef] flex items-center justify-center shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6l4 2"/></svg>
        </div>
        <div>
          <div class="text-lg font-semibold">پنل ادمین — Two Manga</div>
          <div class="small-muted">آدرس بک‌اند: <span id="backendUrl" class="mono">https://two-api-iksq.onrender.com</span></div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right">
          <div id="adminName" class="text-sm small-muted">—</div>
          <div class="text-xs small-muted">سطح دسترسی: <span id="adminRole">—</span></div>
        </div>
        <button id="btnLogout" class="px-4 py-2 rounded-lg bg-gradient-to-r from-[#7c3aed] to-[#d946ef]">خروج</button>
      </div>
    </header>

    <main class="grid grid-cols-12 gap-6">
      <aside class="col-span-3 glass p-4 space-y-4">
        <div class="small-muted">نِویگِیشن</div>
        <nav class="flex flex-col gap-2">
          <button class="p-3 plan-card" data-tab="dashboard" onclick="showTab('dashboard')">داشبورد</button>
          <button class="p-3 plan-card" data-tab="transactions" onclick="showTab('transactions')">تراکنش‌ها</button>
          <button class="p-3 plan-card" data-tab="coupons" onclick="showTab('coupons')">کوپن‌ها</button>
          <button class="p-3 plan-card" data-tab="rates" onclick="showTab('rates')">نرخ‌ها</button>
          <button class="p-3 plan-card" data-tab="logs" onclick="showTab('logs')">لاگ‌ها</button>
        </nav>
      </aside>

      <section class="col-span-9 space-y-6">
        <section id="tab-dashboard" class="glass p-6">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-2xl">داشبورد سلامت</h2>
              <p class="small-muted">وضعیت سرور، DB و queue</p>
            </div>
            <div class="flex gap-2">
              <button id="btnPing" class="px-4 py-2 rounded bg-[#8b5cf6]" onclick="pingServer()">Ping <span id="pingLoader" class="ml-2"></span></button>
              <button id="btnDb" class="px-4 py-2 rounded glass" onclick="dbStatus()">DB</button>
            </div>
          </div>
          <div class="mt-6 grid grid-cols-3 gap-4">
            <div class="p-4 glass">
              <div class="small-muted">Queue / Root</div>
              <div id="rootInfo" class="mono mt-2">—</div>
            </div>
            <div class="p-4 glass">
              <div class="small-muted">Ping</div>
              <div id="pingResult" class="mono mt-2">—</div>
            </div>
            <div class="p-4 glass">
              <div class="small-muted">DB</div>
              <div id="dbResult" class="mono mt-2">—</div>
            </div>
          </div>
        </section>

        <!-- transactions -->
        <section id="tab-transactions" class="glass p-6 hidden">
          <div class="flex justify-between items-center">
            <h2 class="text-xl">تراکنش‌ها</h2>
            <div><select id="filterStatus" class="glass" onchange="loadTransactions()"><option value="">همه</option><option>pending</option><option>approved</option></select><button class="ml-2" onclick="loadTransactions()">بارگذاری</button></div>
          </div>
          <div id="transactionsList" class="mt-4 small-muted">—</div>
        </section>

        <!-- coupons, rates, logs (omitted for brevity in UI) -->
        <section id="tab-coupons" class="glass p-6 hidden"><h2>کوپن‌ها</h2></section>
        <section id="tab-rates" class="glass p-6 hidden"><h2>نرخ‌ها</h2></section>
        <section id="tab-logs" class="glass p-6 hidden"><h2>لاگ‌ها</h2><pre id="rootDump" class="mono small-muted p-2">—</pre></section>
      </section>
    </main>
  </div>

  <!-- blocking initial loader -->
  <div id="initialLoader" class="access-overlay">
    <div class="card glass">
      <div style="display:flex;justify-content:center;"><div class="loader"></div></div>
      <div class="mt-3 small-muted text-center">در حال بررسی احراز هویت... لطفاً صبر کنید.</div>
    </div>
  </div>

  <!-- login overlay (shown when no valid tokens or refresh fails) -->
  <div id="loginOverlay" class="access-overlay hidden">
    <div class="card glass">
      <h3 class="text-xl">ورود ادمین</h3>
      <p class="small-muted mt-2">نام کاربری و رمز عبور ادمین را وارد کنید.</p>
      <div class="mt-4 grid grid-cols-1 gap-2">
        <input id="li_username" placeholder="username" class="p-2 glass" />
        <input id="li_password" type="password" placeholder="password" class="p-2 glass" />
        <div class="flex gap-2 mt-2">
          <button id="li_btn" class="px-4 py-2 bg-[#7c3aed] rounded">ورود</button>
          <button id="li_close" class="px-4 py-2 glass rounded">انصراف</button>
        </div>
        <div id="li_msg" class="small-muted mt-2"></div>
      </div>
    </div>
  </div>

<script>
/* ---------- Config ---------- */
const BACKEND = "https://two-api-iksq.onrender.com";
const AUTH_LOGIN = BACKEND + "/auth/login";
const AUTH_ME = BACKEND + "/auth/me";
const AUTH_REFRESH = BACKEND + "/auth/refresh";

/* ---------- Token helpers ---------- */
function setTokens(access, refresh) {
  if (access) localStorage.setItem("access_token", access);
  if (refresh) localStorage.setItem("refresh_token", refresh);
}
function clearTokens() {
  localStorage.removeItem("access_token");
  localStorage.removeItem("refresh_token");
}
function getAccess() { return localStorage.getItem("access_token"); }
function getRefresh() { return localStorage.getItem("refresh_token"); }

/* ---------- UI helpers ---------- */
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function showApp(){ hide(document.getElementById("initialLoader")); show(document.getElementById("appRoot")); }
function showLoginOverlay(msg){ document.getElementById("li_msg").innerText = msg || ""; show(document.getElementById("loginOverlay")); }
function hideLoginOverlay(){ hide(document.getElementById("loginOverlay")); }

/* ---------- fetch wrapper with auth + refresh ---------- */
async function fetchWithAuth(input, init = {}) {
  init = Object.assign({ headers: {}, credentials: "include" }, init);
  // attach access token if present
  const token = getAccess();
  if (token) init.headers["Authorization"] = "Bearer " + token;
  init.headers["Accept"] = init.headers["Accept"] || "application/json";

  // do request
  let res;
  try {
    res = await fetch(input, init);
  } catch (err) {
    // network / CORS
    console.error("fetch error", err);
    throw err;
  }

  // if unauthorized, try refresh once (only if refresh token exists)
  if (res.status === 401) {
    const refresh = getRefresh();
    if (refresh) {
      // try refresh
      try {
        const r = await fetch(AUTH_REFRESH, {
          method: "POST",
          headers: { "Authorization": "Bearer " + refresh, "Accept": "application/json" },
          credentials: "include"
        });
        if (r.ok) {
          const j = await r.json();
          if (j.access_token) {
            setTokens(j.access_token, refresh); // keep refresh
            // retry original request with new access
            init.headers["Authorization"] = "Bearer " + j.access_token;
            return await fetch(input, init);
          }
        } else {
          // refresh failed -> clear tokens and surface to caller
          clearTokens();
          return res; // original 401
        }
      } catch (e) {
        console.error("refresh failed", e);
        throw e;
      }
    }
  }
  return res;
}

/* ---------- Boot / auth flow ---------- */
async function bootstrap() {
  console.debug("[bootstrap] starting auth check");
  // try auth/me regardless of presence of token
  try {
    const res = await fetchWithAuth(AUTH_ME, { method: "GET" });
    console.debug("[bootstrap] /auth/me status", res.status);
    if (res.ok) {
      const body = await res.json();
      // require server to say role=admin
      if (body.role && body.role === "admin") {
        document.getElementById("adminName").innerText = body.username || "admin";
        document.getElementById("adminRole").innerText = body.role;
        showApp();
        // init default data
        showTab("dashboard");
        fetchRoot();
        return;
      } else {
        clearTokens();
        hide(document.getElementById("initialLoader"));
        showLoginOverlay("اکانت شما ادمین نیست یا دسترسی لازم را ندارید.");
        return;
      }
    } else {
      // if 401 or 403 or other -> show login overlay with hint
      hide(document.getElementById("initialLoader"));
      if (res.status === 401 || res.status === 403) {
        showLoginOverlay("برای دسترسی admin وارد شوید (401/403).");
      } else {
        // other errors: show retry + login
        showLoginOverlay("خطا در بررسی احراز هویت. برای تلاش دوباره وارد شوید.");
      }
      return;
    }
  } catch (err) {
    console.error("[bootstrap] error", err);
    hide(document.getElementById("initialLoader"));
    showLoginOverlay("خطای شبکه یا CORS هنگام بررسی احراز هویت. کنسول را چک کنید.");
  }
}

/* ---------- Login form handling ---------- */
document.getElementById("li_btn").addEventListener("click", async () => {
  const u = document.getElementById("li_username").value.trim();
  const p = document.getElementById("li_password").value;
  if (!u || !p) { document.getElementById("li_msg").innerText = "نام کاربری/رمز معتبر وارد کنید."; return; }
  document.getElementById("li_msg").innerText = "در حال ارسال...";
  try {
    const r = await fetch(AUTH_LOGIN, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      credentials: "include",
      body: JSON.stringify({ username: u, password: p })
    });
    if (!r.ok) {
      const txt = await r.text().catch(()=>"");
      document.getElementById("li_msg").innerText = "ورود ناموفق: " + r.status + " " + txt;
      return;
    }
    const j = await r.json();
    if (j.access_token && j.refresh_token) {
      setTokens(j.access_token, j.refresh_token);
      hideLoginOverlay();
      // retry bootstrap
      show(document.getElementById("initialLoader"));
      await bootstrap();
      return;
    } else {
      document.getElementById("li_msg").innerText = "پاسخ نامعتبر از سرور (توکن نیامد).";
    }
  } catch (e) {
    console.error("login error", e);
    document.getElementById("li_msg").innerText = "خطای شبکه در ورود.";
  }
});

document.getElementById("li_close").addEventListener("click", () => {
  hideLoginOverlay();
  // keep app hidden; user must login or use root/back buttons if you add them later
});

/* ---------- Logout ---------- */
document.getElementById("btnLogout").addEventListener("click", () => {
  clearTokens();
  // show login overlay
  hide(document.getElementById("appRoot"));
  show(document.getElementById("initialLoader"));
  setTimeout(()=>{ hide(document.getElementById("initialLoader")); showLoginOverlay("شما خارج شدید. لطفاً مجدداً وارد شوید."); }, 400);
});

/* ---------- Basic UI helpers & API wrappers ---------- */
function showTab(name){
  document.querySelectorAll("[id^='tab-']").forEach(el => { if (el.id === "tab-"+name) el.classList.remove("hidden"); else el.classList.add("hidden"); });
}
async function fetchRoot(){
  const el = document.getElementById("rootInfo");
  el.innerText = "در حال بارگذاری...";
  try {
    const r = await fetchWithAuth(BACKEND + "/", { method: "GET" });
    if (!r.ok) { el.innerText = "خطا: " + r.status; return; }
    const j = await r.json();
    document.getElementById("rootDump").innerText = JSON.stringify(j,null,2);
    el.innerText = j.server || "Two Manga API";
    return j;
  } catch(e){ el.innerText = "خطای شبکه"; console.error(e); }
}
async function pingServer(){
  document.getElementById("pingLoader").innerHTML = '<span class="loader"></span>';
  try {
    const r = await fetchWithAuth(BACKEND + "/debug/ping", { method: "GET" });
    if (r.ok){ const j = await r.json(); document.getElementById("pingResult").innerText = j.msg || "pong"; } else { document.getElementById("pingResult").innerText = "err " + r.status; }
  } catch(e){ document.getElementById("pingResult").innerText = "خطا"; console.error(e); }
  document.getElementById("pingLoader").innerHTML = "";
}
async function dbStatus(){
  document.getElementById("dbResult").innerText = "loading...";
  try {
    const r = await fetchWithAuth(BACKEND + "/debug/db-status", { method: "GET" });
    if (r.ok) { const j = await r.json(); document.getElementById("dbResult").innerText = "available: " + (j.available ? "yes":"no"); } else { document.getElementById("dbResult").innerText = "err " + r.status; }
  } catch(e){ document.getElementById("dbResult").innerText = "خطا"; console.error(e); }
}
async function loadTransactions(){
  const container = document.getElementById("transactionsList"); container.innerText = "loading...";
  try {
    const status = document.getElementById("filterStatus").value || "";
    const qs = status ? "?status=" + encodeURIComponent(status) : "";
    const r = await fetchWithAuth(BACKEND + "/admin/transactions" + qs, { method: "GET" });
    if (r.status === 401 || r.status === 403) { clearTokens(); hide(document.getElementById("appRoot")); showLoginOverlay("مجدداً وارد شوید (401/403)."); return; }
    if (!r.ok) { container.innerText = "خطا: " + r.status; return; }
    const j = await r.json(); const items = j.transactions || [];
    if (!items.length){ container.innerText = "تراکنشی نیست."; return; }
    container.innerHTML = ""; items.forEach(t => {
      const d = document.createElement("div"); d.className="p-3 glass mb-2";
      d.innerHTML = `<div class="mono">#${t._id} · ${t.username} · ${t.status}</div>`;
      container.appendChild(d);
    });
  } catch(e){ container.innerText = "خطا"; console.error(e); }
}

/* ---------- Init ---------- */
(function init(){
  document.getElementById("backendUrl").innerText = BACKEND;
  // start bootstrap (will call /auth/me via fetchWithAuth)
  bootstrap();
})();
</script>
</body>
</html>
