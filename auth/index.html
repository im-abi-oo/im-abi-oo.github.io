<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ورود به دنیای تومنگ — FIXED</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
          colors: {
            bg: '#020005',
            glass: 'rgba(20, 20, 25, 0.7)',
            accent: '#8b5cf6',
            accentHover: '#7c3aed',
            error: '#ef4444',
            success: '#10b981'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards',
            'slide-up': 'slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>

  <style>
    body { background: #020005; color: #fff; overflow: hidden; font-family: Vazirmatn, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    .orb { position: absolute; border-radius: 50%; filter: blur(120px); opacity: 0.4; z-index: -1; }
    .orb-1 { width: 500px; height: 500px; background: #4c1d95; top: -10%; left: -10%; animation: pulse 10s infinite alternate; }
    .orb-2 { width: 400px; height: 400px; background: #be185d; bottom: -10%; right: -10%; animation: pulse 8s infinite alternate-reverse; }

    .glass-box {
      background: rgba(10, 10, 12, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .input-field {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      transition: all 0.3s;
      direction: ltr;
      text-align: left;
      padding-right: 40px;
    }
    .input-field:focus {
      border-color: #8b5cf6;
      background: rgba(139,92,246,0.04);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.08);
      outline: none;
    }

    .loader { border: 2px solid rgba(255,255,255,0.1); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* tab active */
    #tabs { position: relative; }
    #active-bg { position: absolute; inset-y: 4px; width: calc(50% - 8px); border-radius: 0.75rem; background: linear-gradient(90deg,#7c3aed,#d946ef); opacity: .12; transition: all 0.28s ease; box-shadow: 0 8px 30px rgba(139,92,246,0.08); }

    .small-muted { color: rgba(255,255,255,0.6); font-size: 0.85rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen px-4 relative">

  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <main class="w-full max-w-[420px] glass-box rounded-[1.5rem] p-8 animate-slide-up relative overflow-hidden">
    <div class="absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-transparent via-[#8b5cf6] to-transparent opacity-40"></div>

    <header class="text-center mb-6">
      <h1 class="text-3xl font-black tracking-tighter mb-1">
        <span class="text-white">TWO</span><span class="text-accent">MANG</span>
      </h1>
      <p class="small-muted">دروازه ورود به دنیای مانگا</p>
    </header>

    <!-- Tabs -->
    <div id="tabs" class="grid grid-cols-2 p-1 bg-white/5 rounded-xl mb-6 relative">
      <div id="active-bg" style="left:6px;"></div>
      <button id="tab-login" class="relative z-10 py-2.5 text-sm font-bold transition-colors duration-300 text-white" onclick="setMode('login')">ورود</button>
      <button id="tab-register" class="relative z-10 py-2.5 text-sm font-bold transition-colors duration-300 text-gray-400" onclick="setMode('register')">ثبت نام</button>
    </div>

    <!-- Error Box -->
    <div id="error-box" class="hidden mb-4 p-3 rounded-xl bg-red-500/8 border border-red-500/12 flex items-start gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01"/></svg>
      <p id="error-msg" class="text-sm text-red-200 leading-5 font-bold">خطا</p>
    </div>

    <form id="auth-form" class="space-y-4" onsubmit="handleSubmit(event)">
      <div class="space-y-1">
        <label class="text-[10px] font-bold text-gray-400 px-1 uppercase tracking-wider">نام کاربری</label>
        <div class="relative">
          <input id="username" class="input-field w-full rounded-xl px-4 py-3.5 text-sm font-bold placeholder-gray-600" placeholder="نام کاربری..." required />
          <div style="position:absolute; left:12px; top:12px;"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.121 17.804A9 9 0 1 1 18.879 6.196 9 9 0 0 1 5.12 17.804z"/></svg></div>
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-[10px] font-bold text-gray-400 px-1 uppercase tracking-wider">رمز عبور</label>
        <div class="relative">
          <input id="password" type="password" class="input-field w-full rounded-xl px-4 py-3.5 text-sm font-bold placeholder-gray-600" placeholder="••••••••" required />
          <button type="button" onclick="togglePass()" style="position:absolute; left:10px; top:10px;" class="text-gray-300 hover:text-white">
            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
      </div>

      <div id="register-hint" class="hidden text-[12px] text-gray-400 bg-white/3 p-3 rounded-lg border border-white/6 leading-relaxed">
        نام کاربری فقط حروف انگلیسی و عدد. رمز حداقل ۶ کاراکتر.
      </div>

      <button id="submit-btn" type="submit" class="w-full bg-accent hover:bg-accentHover text-white font-black py-3 rounded-xl shadow-lg shadow-accent/25 flex justify-center items-center gap-2">
        <span id="btn-text">ورود به حساب</span>
      </button>

      <p class="text-center small-muted pt-2">
        <a href="https://t.me/im_abi" target="_blank" class="text-gray-400 hover:text-white">مشکل در ورود؟ پشتیبانی</a>
      </p>
    </form>
  </main>

  <!-- Success modal -->
  <div id="success-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm items-center justify-center p-6">
    <div class="bg-[#0b0b0d] border border-white/6 w-full max-w-sm rounded-3xl p-6 text-center">
      <div class="w-16 h-16 bg-green-500/14 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500/10">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"/></svg>
      </div>
      <h3 class="text-xl font-black text-white mb-2">عملیات موفق</h3>
      <p id="modal-msg" class="text-sm text-gray-400 mb-6">در حال انتقال...</p>
      <div class="flex flex-col gap-2">
        <button onclick="goToPanel()" class="w-full py-3 bg-white/6 hover:bg-white/10 text-white rounded-xl font-bold transition">رفتن به پنل</button>
        <button onclick="closeModal()" class="w-full py-3 bg-accent hover:bg-accentHover text-white rounded-xl font-bold transition">بازگشت</button>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIG ==========
    const BACKEND = "https://two-api-iksq.onrender.com";
    const AUTH_PAGE = "https://im-abi-oo.github.io/auth";
    const PANEL_PAGE = "https://im-abi-oo.github.io/panel";
    const ADMIN_PANEL = "https://im-abi-oo.github.io/admin";
    const TOKEN_KEY = "access_token"; // single canonical key used everywhere

    lucide.createIcons();

    // ========== UI helpers ==========
    function setMode(mode) {
      const tabBg = document.getElementById('active-bg');
      const btnLogin = document.getElementById('tab-login');
      const btnReg = document.getElementById('tab-register');
      const regHint = document.getElementById('register-hint');
      const btnText = document.getElementById('btn-text');

      if (mode === 'login') {
        tabBg.style.left = '6px';
        btnLogin.classList.remove('text-gray-400'); btnLogin.classList.add('text-white');
        btnReg.classList.remove('text-white'); btnReg.classList.add('text-gray-400');
        regHint.classList.add('hidden');
        btnText.innerText = "ورود به حساب";
        currentMode = 'login';
      } else {
        tabBg.style.left = 'calc(50% + 6px)';
        btnLogin.classList.remove('text-white'); btnLogin.classList.add('text-gray-400');
        btnReg.classList.remove('text-gray-400'); btnReg.classList.add('text-white');
        regHint.classList.remove('hidden');
        btnText.innerText = "ثبت نام و شروع";
        currentMode = 'register';
      }
    }

    function togglePass() {
      const inp = document.getElementById('password');
      inp.type = inp.type === 'password' ? 'text' : 'password';
    }

    // ========== Token helpers ==========
    function storeToken(token, refresh) {
      if (!token) return;
      localStorage.setItem(TOKEN_KEY, token);
      if (refresh) localStorage.setItem("refresh_token", refresh);
      // keep backward compatibility keys (some old code looked for these)
      localStorage.setItem("twomanga_access", token);
      localStorage.setItem("twomanga_access_token", token);
    }
    function getStoredToken() {
      return localStorage.getItem(TOKEN_KEY) || localStorage.getItem("twomanga_access") || localStorage.getItem("twomanga_access_token") || null;
    }
    function clearToken() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem("twomanga_access");
      localStorage.removeItem("twomanga_access_token");
      localStorage.removeItem("refresh_token");
    }

    function authHeaders(token) {
      const tk = token || getStoredToken();
      return tk ? { "Authorization": "Bearer " + tk } : {};
    }

    // ========== UI messages ==========
    function showError(msg) {
      const box = document.getElementById('error-box');
      const txt = document.getElementById('error-msg');
      txt.innerText = msg;
      box.classList.remove('hidden');
    }
    function hideError() {
      document.getElementById('error-box').classList.add('hidden');
    }

    function showSuccessModal(msg) {
      document.getElementById('modal-msg').innerText = msg;
      const m = document.getElementById('success-modal');
      m.classList.remove('hidden');
      m.style.display = 'flex';
    }
    function closeModal() {
      const m = document.getElementById('success-modal');
      m.classList.add('hidden');
      m.style.display = 'none';
    }
    function goToPanel() {
      // decide destination by role check
      checkMeAndRedirect();
    }

    // ========== Core logic ==========
    let currentMode = 'login'; // default
    document.addEventListener('DOMContentLoaded', () => {
      setMode('login');
      // keyboard: enter submits
      document.getElementById('auth-form').addEventListener('submit', handleSubmit);
    });

    async function handleSubmit(e) {
      e && e.preventDefault();
      hideError();

      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      const btn = document.getElementById('submit-btn');
      const btnText = document.getElementById('btn-text');

      // basic validation
      if (!user || !pass) {
        return showError("نام کاربری یا رمز ناقص است.");
      }
      if (currentMode === 'register') {
        const regex = /^[a-z0-9]+$/i;
        if (!regex.test(user)) return showError("نام کاربری فقط حروف انگلیسی و عدد (بدون فاصله).");
        if (pass.length < 6) return showError("رمز عبور باید حداقل ۶ کاراکتر باشد.");
      }

      // disable button + loader
      btn.disabled = true;
      const old = btn.innerHTML;
      btn.innerHTML = '<div class="loader"></div>';

      try {
        const res = await fetch(`${BACKEND}/auth/${currentMode}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });

        const data = await res.json().catch(()=>({}));

        if (!res.ok) {
          // show server message if present
          const msg = data && data.msg ? data.msg : `خطا (${res.status})`;
          throw new Error(msg);
        }

        // must receive access_token
        if (!data.access_token) {
          throw new Error("توکن از سرور دریافت نشد.");
        }

        // store canonical token
        storeToken(data.access_token, data.refresh_token);

        // for register: show success and then check/me redirect
        if (currentMode === 'register') {
          showSuccessModal("ثبت نام انجام شد. در حال ورود خودکار...");
          // after a short delay, validate token & redirect
          setTimeout(() => checkMeAndRedirect(), 900);
        } else {
          // login: validate /auth/me and decide destination
          await checkMeAndRedirect();
        }

      } catch (err) {
        showError(err.message || "خطایی رخ داد");
        btn.innerHTML = old;
        btn.disabled = false;
      }
    }

    // call /auth/me to learn role and days_left. Handles network errors gracefully.
    async function checkMeAndRedirect() {
      const token = getStoredToken();
      if (!token) {
        // fallback: redirect to auth page (shouldn't happen)
        clearToken();
        return window.location.href = AUTH_PAGE;
      }

      try {
        const res = await fetch(`${BACKEND}/auth/me`, {
          method: 'GET',
          headers: { 'Accept': 'application/json', ...authHeaders(token) }
        });

        // Handle common non-200 responses
        if (res.status === 401 || res.status === 403) {
          clearToken();
          showError("احراز هویت شما معتبر نیست. لطفاً دوباره وارد شوید.");
          // small delay then redirect to login page
          setTimeout(()=> window.location.href = AUTH_PAGE, 1200);
          return;
        }

        if (!res.ok) {
          // server error but don't force immediate redirect; show message and allow user to retry
          const text = await res.text().catch(()=>"");
          showError("خطای سرور هنگام بررسی حساب: " + (text || res.status));
          return;
        }

        const body = await res.json().catch(()=>({}));
        // defensive checks: different server shapes
        // prefer body.role if present; try body.username/body.days_left etc.
        const role = (body && body.role) ? body.role : (body.user && body.user.role ? body.user.role : null);
        const days_left = (typeof body.days_left === 'number') ? body.days_left
                        : (body.user && typeof body.user.days_left === 'number') ? body.user.days_left
                        : (body.is_premium ? (body.expiry_date ? 1 : 0) : 0);

        // if server response doesn't match expected, just redirect to panel (safe)
        if (!role) {
          // we have a token and server returned something; assume regular user and go to panel
          return window.location.href = PANEL_PAGE;
        }

        if (role.toLowerCase() === 'admin') {
          // admin: go to admin panel
          window.location.href = ADMIN_PANEL;
        } else {
          // not admin: go to public panel (normal flow)
          // if subscription exists, you may route to homepage or panel; keep behavior consistent:
          window.location.href = PANEL_PAGE;
        }

      } catch (e) {
        // Network/timeout case: show non-fatal message so user isn't booted silently
        console.error("checkMeAndRedirect network error:", e);
        showError("خطای شبکه — بررسی وضعیت حساب ممکن نیست. دوباره تلاش کنید.");
        // optionally keep token (avoid clearing) and let user retry manually
      }
    }

    // small init: if there is already a valid token stored, try to validate silently
    (function init() {
      const existing = getStoredToken();
      if (existing) {
        // try a silent check but don't aggressively redirect on network errors
        checkMeAndRedirect();
      }
    })();
  </script>
</body>
</html>
