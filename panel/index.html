<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>پنل کاربری | TwoManga</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

    <!-- === User injected styles (use ASCII digits, no Persian numerals) === -->
    <style>
        body { background: #000 radial-gradient(at top right, #1e1b4b 0%, #000000 60%); color: #e4e4e7; overflow-x: hidden; font-family: 'Vazirmatn', sans-serif; }
        .glass { background: rgba(24, 24, 27, 0.65); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .input-glass { background: rgba(0,0,0,0.4); border: 1px solid #3f3f46; color: white; transition: all 0.3s; }
        .input-glass:focus { border-color: #8b5cf6; outline: none; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

        .loader { border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .badge { padding: .25rem .5rem; border-radius: .375rem; font-size: .75rem; font-weight: 700; border: 1px solid rgba(255,255,255,0.06); }

        /* Centered modal (purchase) */
        #wizard-modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity .2s ease; }
        #wizard-modal.open { pointer-events: auto; opacity: 1; }
        #wizard-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(6px); }
        #wizard-content { position: relative; width: 96%; max-width: 720px; max-height: 90vh; overflow: hidden; border-radius: 1rem; }

        /* Steps container scroll */
        .wizard-body { padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 160px); -webkit-overflow-scrolling: touch; }

        /* Top bar */
        .topbar { position: sticky; top: 0; z-index: 50; }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            #wizard-content { width: 720px; }
        }
    </style>
    <!-- ===================================================== -->
</head>
<body>

    <!-- TOPBAR: back button to root -->
    <div class="topbar glass px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button onclick="location.href='/'" class="flex items-center gap-2 px-3 py-2 rounded-md bg-white/5 hover:bg-white/8 transition">
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                <span>برگشت</span>
            </button>
        </div>
        <div class="font-black text-lg">TWOMANGA</div>
        <div class="text-sm text-gray-400"> </div>
    </div>

    <!-- MAIN -->
    <main class="p-6 max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-bold text-white">پنل کاربری</h1>
                <p class="text-sm text-gray-400">به پنل مدیریت اکانت خوش آمدید.</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="logout()" class="px-3 py-2 rounded-md bg-red-600/10 text-red-300 hover:bg-red-600/20">خروج</button>
                <button onclick="fetchProfile()" class="px-3 py-2 rounded-md bg-white/5 hover:bg-white/8">بروزرسانی</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Status Card -->
            <div class="lg:col-span-2 glass rounded-2xl p-6">
                <p class="text-sm text-gray-400 mb-2">وضعیت اشتراک</p>
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="plan-status" class="text-3xl font-extrabold">...</h2>
                        <div id="days-badge" class="badge mt-2 inline-flex items-center gap-2 bg-green-500/6 text-green-300 border-green-500/20">
                            <span id="days-left-text">در حال بارگذاری...</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">نقش کاربری</p>
                        <p id="user-role" class="font-bold text-white">...</p>
                    </div>
                </div>

                <div class="mt-6">
                    <button onclick="openWizard()" class="px-4 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-bold shadow">تمدید / خرید اشتراک</button>
                </div>
            </div>

            <!-- Gift Card -->
            <div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-bold text-white">کد هدیه</h3>
                        <p class="text-xs text-gray-400">کد هدیه خود را وارد کنید تا روزهای اشتراک اضافه شود.</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <input id="gift-input" class="input-glass w-full rounded-xl px-4 py-3 text-sm" placeholder="GIFT-CODE">
                    <button id="btn-gift" onclick="submitGift()" class="w-full py-3 rounded-xl bg-white/5 hover:bg-white/8">اعمال کد</button>
                </div>
            </div>
        </div>
    </main>

    <!-- CENTERED WIZARD MODAL -->
    <div id="wizard-modal" aria-hidden="true">
        <div id="wizard-backdrop" onclick="closeWizard()"></div>

        <div id="wizard-content" class="glass">
            <!-- header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-white/6">
                <div class="flex items-center gap-2">
                    <i data-lucide="shopping-bag" class="w-5 h-5 text-indigo-400"></i>
                    <h3 class="font-bold text-white">خرید اشتراک</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="closeWizard()" class="text-gray-300 hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- steps indicator -->
            <div class="px-6 pt-6 pb-2">
                <div class="flex items-center justify-between relative">
                    <div class="absolute top-1/2 left-0 w-full h-1 bg-white/3 -z-10 rounded-full"></div>
                    <div id="step-ind-1" class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold">1</div>
                    <div id="step-ind-2" class="w-8 h-8 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center font-bold">2</div>
                    <div id="step-ind-3" class="w-8 h-8 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center font-bold">3</div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-2 px-1">
                    <span>انتخاب پلن</span>
                    <span>انتخاب ارز</span>
                    <span>تایید</span>
                </div>
            </div>

            <!-- body -->
            <div class="wizard-body">
                <!-- STEP 1 -->
                <div id="step-1" class="space-y-4">
                    <h4 class="text-center font-bold text-white">پلن موردنظر را انتخاب کنید</h4>
                    <div id="plans-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                    <div class="flex justify-between mt-4">
                        <button onclick="closeWizard()" class="px-4 py-2 rounded-md bg-white/5">انصراف</button>
                        <button id="to-step-2" onclick="goToStep(2)" class="px-4 py-2 rounded-md bg-indigo-600 text-white">مرحله بعد</button>
                    </div>
                </div>

                <!-- STEP 2 -->
                <div id="step-2" class="hidden space-y-4">
                    <div class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer" onclick="goToStep(1)">
                        <i data-lucide="arrow-right" class="w-4 h-4"></i> بازگشت
                    </div>
                    <h4 class="text-center font-bold text-white">ارز موردنظر را انتخاب کنید</h4>
                    <div id="crypto-container" class="grid grid-cols-2 gap-4"></div>

                    <div class="flex justify-between mt-4">
                        <button onclick="goToStep(1)" class="px-4 py-2 rounded-md bg-white/5">مرحله قبل</button>
                        <button onclick="goToStep(3)" class="px-4 py-2 rounded-md bg-indigo-600 text-white">مرحله بعد</button>
                    </div>
                </div>

                <!-- STEP 3 -->
                <div id="step-3" class="hidden space-y-4 text-center">
                    <div class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer" onclick="goToStep(2)">
                        <i data-lucide="arrow-right" class="w-4 h-4"></i> بازگشت
                    </div>

                    <div class="p-4 rounded-xl bg-indigo-900/10 border border-indigo-600/20">
                        <p class="text-sm text-indigo-300 mb-1">مبلغ قابل پرداخت</p>
                        <div id="final-price-display" class="text-2xl font-black">0 تومان</div>
                        <div id="final-price-crypto" class="text-xs text-gray-400 mt-1">...</div>
                    </div>

                    <div class="text-right space-y-2">
                        <label class="text-xs text-gray-400">آدرس کیف پول (<span id="wallet-label"></span>):</label>
                        <div class="flex gap-2">
                            <div id="wallet-address-display" class="flex-1 p-3 font-mono text-xs bg-black/20 rounded-lg break-all">...</div>
                            <button onclick="copyWallet()" class="px-4 py-2 rounded-md bg-white/6">کپی</button>
                        </div>

                        <label class="text-xs text-gray-400">کد رهگیری تراکنش (TX Hash):</label>
                        <input id="tx-hash-input" class="input-glass w-full rounded-xl px-4 py-3 text-sm" placeholder="مثلا: 7a82f..." />
                    </div>

                    <div class="flex justify-between mt-4">
                        <button onclick="goToStep(2)" class="px-4 py-2 rounded-md bg-white/5">مرحله قبل</button>
                        <button id="btn-pay-confirm" onclick="confirmPayment()" class="px-4 py-2 rounded-md bg-gradient-to-r from-purple-600 to-indigo-500 text-white">ثبت پرداخت و فعالسازی</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-black/70 border border-white/6 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-3 translate-y-20 opacity-0 transition-all duration-300 z-[200]">
        <i id="toast-icon" data-lucide="info" class="w-5 h-5 text-indigo-400"></i>
        <span id="toast-msg" class="text-sm font-medium">پیام سیستم</span>
    </div>

    <script>
        // CONFIG (prices in Toman as requested; numeric digits are ASCII)
        const CONFIG = {
            API_BASE: "https://two-api-4c7i.onrender.com",
            NOBITEX_API: "https://apiv2.nobitex.ir",
            WALLETS: { TRX: "TCne3Bt8ZohH4E6ZrSoHT7pnw285HE72B3", USDT: "TCne3Bt8ZohH4E6ZrSoHT7pnw285HE72B3", TON: "UQBc8sYVNAPhlqVjaoRlx8HAmVS1xGKD2yMmHHoeMynQtHFM", SOL: "J4VEzqyqMa4BD8VfjicVHjLKwKRG3LyTMHiKTzuTbZrj" },
            PLANS: [
                { id: 1, days: 30, priceToman: 70000, label: "نقره", desc: "پلن 1 ماهه" },
                { id: 2, days: 90, priceToman: 198000, label: "طلا", desc: "پلن 3 ماهه" },
                { id: 3, days: 180, priceToman: 399000, label: "برنز", desc: "پلن 6 ماهه" },
                { id: 4, days: 365, priceToman: 798000, label: "الماس", desc: "پلن 1 ساله" }
            ],
            CRYPTOS: [
                { id: 'TRX', name: 'Tron (TRX)', icon: 'https://cryptologos.cc/logos/tron-trx-logo.png?v=025' },
                { id: 'USDT', name: 'Tether (USDT)', icon: 'https://cryptologos.cc/logos/tether-usdt-logo.png?v=025' },
                { id: 'TON', name: 'Toncoin (TON)', icon: 'https://cryptologos.cc/logos/toncoin-ton-logo.png?v=025' },
                { id: 'SOL', name: 'Solana (SOL)', icon: 'https://cryptologos.cc/logos/solana-sol-logo.png?v=025' }
            ],
            NOBITEX_SYMBOLS: { USDT: 'USDTIRT', TRX: 'TRXIRT', TON: 'TONIRT', SOL: 'SOLIRT' }
        };

        let state = { user: null, selectedPlan: null, selectedCrypto: null };

        const getAuthHeaders = () => {
            const token = localStorage.getItem('at');
            return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
        };

        // ====== جایگزین شده: fetchProfile با کش و محافظت در برابر خطای شبکه/سرور ======
        async function fetchProfile() {
            try {
                // اگر توکن نیست برو /auth
                if (!localStorage.getItem('at')) { window.location.href = '/auth'; return; }

                const res = await fetch(`${CONFIG.API_BASE}/auth/me`, { headers: getAuthHeaders() });

                // توکن نامعتبر یا منقضی شده
                if (res.status === 401) {
                    logout();
                    return;
                }

                // تلاش برای خواندن JSON (ممکنه سرور خطا html یا empty برگردونه)
                let data = null;
                try {
                    data = await res.json();
                } catch (e) {
                    console.warn('fetchProfile: response is not json or empty', e);
                }

                if (res.ok && data) {
                    // پاسخ سالم: UI را به‌روز کن و کش بزن برای استفادهٔ بعدی
                    state.user = data;
                    try { localStorage.setItem('profile_cache', JSON.stringify(data)); } catch (e) { /* ignore storage errors */ }
                    updateDashboardUI(data);
                } else {
                    // وضعیت خطا از سمت سرور یا پاسخ نامعتبر
                    const serverMsg = data && data.msg ? data.msg : null;

                    // اگر کش محلی داریم — آن را نمایش بده و فقط یک توست خطا نشان بده
                    const cached = localStorage.getItem('profile_cache');
                    if (cached) {
                        try {
                            const cachedUser = JSON.parse(cached);
                            state.user = cachedUser;
                            updateDashboardUI(cachedUser);
                            showToast(serverMsg || "خطا در ارتباط با سرور — اطلاعات محلی نمایش داده شد", "error");
                            return;
                        } catch (e) {
                            console.warn("failed to parse profile_cache", e);
                        }
                    }

                    // هیچ کشی نیست -> نمایش خطا و (اختیاری) تنظیم UI به حالت قابل فهم
                    showToast(serverMsg || "خطا در ارتباط با سرور", "error");
                    // با توجه به درخواستت، از تغییر دادن وضعیت فعلی UI خودداری کردم
                }
            } catch (err) {
                console.error("fetchProfile network error:", err);

                // خطای شبکه: اگر کش محلی هست از آن استفاده کن، وگرنه فقط پیغام خطا نمایش بده
                const cached = localStorage.getItem('profile_cache');
                if (cached) {
                    try {
                        const cachedUser = JSON.parse(cached);
                        state.user = cachedUser;
                        updateDashboardUI(cachedUser);
                        showToast("قطع ارتباط با سرور — اطلاعات کش شده نمایش داده شد", "error");
                        return;
                    } catch (e) {
                        console.warn("failed to parse profile_cache", e);
                    }
                }

                showToast("خطا در ارتباط با سرور", "error");
                // توجه: اینجا هم عمداً وضعیت اشتراک را بازنویسی نکردم
            }
        }

        // ====== جایگزین شده: updateDashboardUI با عدم پاک‌سازی غیرضروری UI ======
        function updateDashboardUI(user) {
            if (!user) return; // ایمن‌سازی در برابر فراخوانی با مقدار خالی

            // فقط زمانی که فیلد days_left واقعاً در پاسخ وجود دارد آن را اعمال کن
            if (Object.prototype.hasOwnProperty.call(user, 'days_left')) {
                const daysLeft = Number(user.days_left ?? 0);
                const daysEl = document.getElementById('days-left-text');
                const planStatusEl = document.getElementById('plan-status');
                const daysBadgeEl = document.getElementById('days-badge');

                if (daysEl) daysEl.innerText = daysLeft > 0 ? `${daysLeft} روز باقی‌مانده` : "منقضی شده";
                if (planStatusEl) planStatusEl.innerText = daysLeft > 0 ? "فعال ✅" : "غیرفعال ❌";
                if (daysBadgeEl) {
                    daysBadgeEl.className = daysLeft > 0
                        ? "badge mt-2 inline-flex items-center gap-2 bg-green-500/6 text-green-300 border-green-500/20"
                        : "badge mt-2 inline-flex items-center gap-2 bg-red-500/6 text-red-300 border-red-500/20";
                }
            } else {
                // اگر اطلاعات days_left نیامده است، وضعیت قبلی را حفظ کن (پاکش نکن)
                console.debug("updateDashboardUI: days_left not provided — keeping existing UI state");
            }

            // نقش کاربری (اگر ارسال شده) را آپدیت کن
            if (Object.prototype.hasOwnProperty.call(user, 'role')) {
                const roleEl = document.getElementById('user-role');
                if (roleEl) roleEl.innerText = (user.role === 'admin') ? 'مدیر کل' : 'کاربر عادی';
            }

            // expiry_iso فقط در صورت وجود فرمت بشه (در صفحه‌ای که expiry-date نباشد، کاری انجام نمی‌شود)
            if (user.expiry_iso) {
                const expiryEl = document.getElementById('expiry-date');
                if (expiryEl) {
                    const d = new Date(user.expiry_iso);
                    try {
                        const fmt = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { year: 'numeric', month: 'numeric', day: 'numeric' });
                        expiryEl.innerText = fmt.format(d);
                    } catch (e) {
                        expiryEl.innerText = d.toLocaleDateString();
                    }
                }
            }
        }

        // بقیهٔ اسکریپت بدون تغییر (منطق خرید، کوپن و نوبیتکس)
        function logout() { localStorage.removeItem('at'); localStorage.removeItem('rt'); window.location.href = '/auth'; }

        function openWizard() {
            document.getElementById('wizard-modal').classList.add('open');
            renderPlans();
            goToStep(1);
        }
        function closeWizard() {
            document.getElementById('wizard-modal').classList.remove('open');
            state.selectedPlan = null; state.selectedCrypto = null;
            document.getElementById('tx-hash-input').value = "";
        }

        function goToStep(step) {
            [1,2,3].forEach(i => document.getElementById(`step-${i}`).classList.add('hidden'));
            [1,2,3].forEach(i => {
                const el = document.getElementById(`step-ind-${i}`);
                if (i < step) { el.className = "w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold"; el.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>'; }
                else if (i === step) { el.className = "w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"; el.innerText = i; }
                else { el.className = "w-8 h-8 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center font-bold"; el.innerText = i; }
            });
            document.getElementById(`step-${step}`).classList.remove('hidden');
            lucide.createIcons();
        }

        function renderPlans() {
            const container = document.getElementById('plans-container'); container.innerHTML = '';
            CONFIG.PLANS.forEach(plan => {
                const el = document.createElement('div');
                const selected = state.selectedPlan?.id === plan.id;
                el.className = `p-4 rounded-2xl border-2 ${selected ? 'border-indigo-500 bg-indigo-900/10' : 'border-white/6 bg-black/10'} cursor-pointer transition`;
                el.onclick = () => { state.selectedPlan = plan; renderPlans(); };
                el.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <div class="text-sm text-gray-400">${plan.desc}</div>
                            <div class="font-bold text-white text-lg mt-1">${plan.label}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold text-indigo-300">${plan.priceToman.toLocaleString('en-US')} تومان</div>
                            <div class="text-xs text-gray-400">${plan.days} روز</div>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function renderCryptos() {
            const container = document.getElementById('crypto-container'); container.innerHTML = '';
            CONFIG.CRYPTOS.forEach(c => {
                const el = document.createElement('div');
                const selected = state.selectedCrypto?.id === c.id;
                el.className = `p-4 rounded-2xl border-2 ${selected ? 'border-indigo-500 bg-indigo-900/8' : 'border-white/6 bg-black/10'} flex flex-col items-center gap-2 cursor-pointer`;
                el.onclick = async () => { state.selectedCrypto = c; renderCryptos(); await preparePayment(); };
                el.innerHTML = `<img src="${c.icon}" class="w-10 h-10 rounded-full" alt="${c.name}"><div class="text-sm font-bold text-white">${c.name}</div>`;
                container.appendChild(el);
            });
        }

        async function fetchNobitexLastPriceRials(cryptoId) {
            try {
                const symbol = CONFIG.NOBITEX_SYMBOLS[cryptoId];
                if (!symbol) return null;
                const res = await fetch(`${CONFIG.NOBITEX_API}/v3/orderbook/${symbol}`);
                if (!res.ok) return null;
                const j = await res.json();
                if (j && j.lastTradePrice) return Number(j.lastTradePrice);
                return null;
            } catch (e) {
                console.warn('Nobitex error', e);
                return null;
            }
        }

        async function preparePayment() {
            const plan = state.selectedPlan; const crypto = state.selectedCrypto;
            if (!plan || !crypto) return;
            const priceRial = Number(plan.priceToman) * 10;
            const lastRial = await fetchNobitexLastPriceRials(crypto.id);
            const finalPriceDisplay = document.getElementById('final-price-display');
            const finalPriceCrypto = document.getElementById('final-price-crypto');

            finalPriceDisplay.innerText = `${plan.priceToman.toLocaleString('en-US')} تومان`;

            if (lastRial && lastRial > 0) {
                const cryptoAmount = priceRial / lastRial;
                finalPriceCrypto.innerText = `≈ ${cryptoAmount.toFixed(6)} ${crypto.id} (نرخ: ${lastRial.toLocaleString('en-US')} ریال)`;
            } else {
                finalPriceCrypto.innerText = `قابلیت محاسبه آنلاین در دسترس نیست — از آدرس ${crypto.id} استفاده کنید`;
            }

            const wl = document.getElementById('wallet-label'); const wa = document.getElementById('wallet-address-display');
            if (wl) wl.innerText = crypto.name;
            if (wa) wa.innerText = CONFIG.WALLETS[crypto.id] || "آدرسی یافت نشد";
        }

        function copyWallet() {
            const addr = document.getElementById('wallet-address-display').innerText;
            navigator.clipboard.writeText(addr).then(()=> showToast("آدرس کپی شد", "success")).catch(()=> showToast("کپی ناموفق", "error"));
        }

        async function confirmPayment() {
            const txHash = document.getElementById('tx-hash-input').value.trim();
            if (!txHash) { showToast("لطفا کد رهگیری تراکنش را وارد کنید", "error"); return; }
            const btn = document.getElementById('btn-pay-confirm'); const orig = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span>'; btn.disabled = true;

            try {
                const payload = { days: state.selectedPlan.days, tx_hash: txHash, coupon_code: null };
                const res = await fetch(`${CONFIG.API_BASE}/payment/submit`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(payload) });
                const data = await res.json();
                if (res.ok || res.status === 201 || res.status === 202) {
                    showToast("تراکنش ثبت شد و در انتظار تایید است", "success");
                    closeWizard(); fetchProfile();
                } else {
                    const msg = data && data.msg ? data.msg : "خطا در ثبت تراکنش";
                    showToast(msg, "error");
                }
            } catch (e) {
                showToast("خطای شبکه", "error");
            } finally {
                btn.innerHTML = orig; btn.disabled = false;
            }
        }

        async function submitGift() {
            const code = document.getElementById('gift-input').value.trim();
            if (!code) { showToast("لطفا کد را وارد کنید", "error"); return; }
            const btn = document.getElementById('btn-gift'); const orig = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span>'; btn.disabled = true;
            try {
                const payload = { coupon_code: code };
                const res = await fetch(`${CONFIG.API_BASE}/payment/submit`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(payload) });
                const data = await res.json();
                if (res.ok) {
                    showToast("کوپن شما اعمال شد", "success");
                    document.getElementById('gift-input').value = "";
                    fetchProfile();
                } else {
                    const errMsg = data && data.msg ? data.msg : "کوپن نامعتبر یا منقضی شده است";
                    showToast(errMsg, "error");
                }
            } catch (e) {
                showToast("خطای شبکه", "error");
            } finally {
                btn.innerHTML = orig; btn.disabled = false;
            }
        }

        function showToast(msg, type='info') {
            const toast = document.getElementById('toast'); const icon = document.getElementById('toast-icon'); const text = document.getElementById('toast-msg');
            text.innerText = msg;
            toast.classList.remove('translate-y-20','opacity-0');
            if (type === 'success') { icon.setAttribute('data-lucide','check-circle'); icon.className = 'w-5 h-5 text-green-400'; }
            else if (type === 'error') { icon.setAttribute('data-lucide','alert-circle'); icon.className = 'w-5 h-5 text-red-400'; }
            else { icon.setAttribute('data-lucide','info'); icon.className = 'w-5 h-5 text-indigo-400'; }
            lucide.createIcons();
            setTimeout(()=> { toast.classList.add('translate-y-20','opacity-0'); }, 3000);
        }

        // initial rendering
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderPlans();
            renderCryptos();
            fetchProfile();
        });
    </script>
</body>
</html>
