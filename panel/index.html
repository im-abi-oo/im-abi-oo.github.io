<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ | TwoManga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#050505', card: '#0F0F10', input: '#18181B', border: '#27272A' },
                        brand: { primary: '#6366f1', secondary: '#a855f7', accent: '#ec4899' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards', 'slide-up': 'slideUp 0.4s ease-out forwards' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #e4e4e7; overflow-x: hidden; font-family: Vazirmatn, sans-serif; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #0f0f10; } ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
        .glass { background: rgba(15,15,16,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .gradient-text { background: linear-gradient(to right,#818cf8,#c084fc,#f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #818cf8; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
        @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .step-active { border-color: #818cf8; background: rgba(99,102,241,0.1); }
        .step-inactive { border-color: #27272A; opacity: 0.5; }

        /* Drawer styles */
        #wizard-drawer { position: fixed; top:0; right:0; height:100vh; width:100%; max-width:520px; transform: translateX(110%); transition: transform .32s cubic-bezier(.2,.9,.2,1); z-index:110; }
        #wizard-drawer.open { transform: translateX(0); }
        #wizard-backdrop { position: fixed; inset:0; background:rgba(0,0,0,0.6); opacity:0; pointer-events:none; transition:opacity .25s; z-index:100; }
        #wizard-backdrop.show { opacity:1; pointer-events:auto; }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">

    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden md:flex flex-col w-72 h-screen sticky top-0 border-l border-dark-border bg-dark-card/50 backdrop-blur-xl p-6 z-40">
        <div class="flex items-center gap-3 mb-10">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-primary to-brand-accent flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-brand-primary/20">TM</div>
            <div>
                <h1 class="font-black text-xl tracking-tight text-white">TWOMANGA</h1>
                <p class="text-[10px] text-gray-500 font-mono">DASHBOARD</p>
            </div>
        </div>

        <nav class="flex-1 space-y-2">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all bg-white/5 text-white shadow-inner border border-white/5">
                <i data-lucide="layout-dashboard" class="w-5 h-5 text-brand-secondary"></i><span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
            </button>
            <button onclick="openWizard()" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i><span>Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©</span>
            </button>
        </nav>

        <div class="mt-auto pt-6 border-t border-dark-border">
            <button onclick="logout()" class="flex items-center gap-2 text-red-400 hover:text-red-300 transition-colors text-sm font-medium w-full px-2">
                <i data-lucide="log-out" class="w-4 h-4"></i><span>Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</span>
            </button>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <header class="md:hidden flex items-center justify-between p-4 glass sticky top-0 z-50">
        <div class="font-black text-lg gradient-text">TWOMANGA</div>
        <button onclick="openWizard()" class="p-2 rounded-lg bg-white/5 text-white">
            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full relative">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-8 animate-fade-in">
            <div>
                <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Ø³Ù„Ø§Ù…ØŒ <span id="username-display" class="text-brand-primary">...</span> ğŸ‘‹</h2>
                <p class="text-gray-400 text-sm">Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ú©Ø§Ù†Øª Ø®ÙˆØ¯ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="fetchProfile()" class="p-2.5 rounded-xl bg-dark-card border border-dark-border hover:border-brand-primary/50 transition-colors text-gray-400 hover:text-white" title="Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="dashboard-tab" class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-slide-up">
            <div class="lg:col-span-2 glass rounded-3xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-primary via-brand-secondary to-brand-accent"></div>
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-brand-primary/10 rounded-full blur-3xl group-hover:bg-brand-primary/20 transition-all duration-700"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-gray-400 text-sm mb-1 font-medium">ÙˆØ¶Ø¹ÛŒØª Ø§Ø´ØªØ±Ø§Ú©</p>
                        <h3 id="plan-status" class="text-3xl font-black text-white mb-4">...</h3>
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 text-green-400 text-xs border border-green-500/20" id="days-badge">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                            <span id="days-left-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                        </div>
                    </div>
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 flex items-center justify-center border border-white/10">
                        <i data-lucide="zap" class="w-7 h-7 text-yellow-400 fill-yellow-400/20"></i>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-white/5 flex gap-4">
                    <button onclick="openWizard()" class="flex-1 py-3 px-4 rounded-xl bg-white text-black font-bold hover:scale-[1.02] active:scale-[0.98] transition-all shadow-[0_0_20px_-5px_rgba(255,255,255,0.3)]">
                        ØªÙ…Ø¯ÛŒØ¯ / Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©
                    </button>
                </div>
            </div>

            <div class="glass rounded-3xl p-6 flex flex-col justify-between">
                <div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 rounded-lg bg-pink-500/10 text-pink-400"><i data-lucide="gift" class="w-5 h-5"></i></div>
                        <h3 class="font-bold text-lg text-white">Ú©Ø¯ Ù‡Ø¯ÛŒÙ‡</h3>
                    </div>
                    <p class="text-xs text-gray-500 mb-4 leading-relaxed">Ø§Ú¯Ø± Ú©Ø¯ Ù‡Ø¯ÛŒÙ‡ ÛŒØ§ Ø¬Ø§ÛŒØ²Ù‡ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¢Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯.</p>
                </div>
                <div class="space-y-3">
                    <input type="text" id="gift-input" class="w-full bg-dark-input border border-dark-border rounded-xl px-4 py-3 text-center text-white placeholder-gray-600 focus:outline-none focus:border-brand-secondary transition-colors font-mono uppercase tracking-widest" placeholder="GIFT-CODE">
                    <button onclick="submitGift()" id="btn-gift" class="w-full py-3 rounded-xl bg-dark-card border border-dark-border hover:bg-dark-border text-gray-300 font-medium text-sm transition-all flex justify-center items-center gap-2">
                        <span>Ø§Ø¹Ù…Ø§Ù„ Ú©Ø¯</span><i data-lucide="arrow-left" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-dark-card/50 border border-dark-border rounded-2xl p-4 flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400"><i data-lucide="user" class="w-5 h-5"></i></div>
                    <div><p class="text-xs text-gray-500">Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±ÛŒ</p><p id="user-role" class="font-bold text-white capitalize">...</p></div>
                </div>
                <div class="bg-dark-card/50 border border-dark-border rounded-2xl p-4 flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-purple-500/10 flex items-center justify-center text-purple-400"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                    <div><p class="text-xs text-gray-500">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</p><p id="expiry-date" class="font-bold text-white dir-ltr text-right">...</p></div>
                </div>
            </div>
        </div>
    </main>

    <!-- WIZARD DRAWER (Purchase Flow) -->
    <div id="wizard-backdrop" onclick="closeWizard()"></div>
    <div id="wizard-drawer" class="glass rounded-l-3xl overflow-hidden shadow-2xl max-h-[100vh]">
        <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
            <h3 class="font-bold text-white flex items-center gap-2">
                <i data-lucide="shopping-bag" class="w-5 h-5 text-brand-secondary"></i> Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©
            </h3>
            <div class="flex items-center gap-2">
                <button onclick="closeWizard()" class="text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
        </div>

        <!-- Steps Indicator -->
        <div class="px-6 pt-6 pb-2">
            <div class="flex items-center justify-between relative">
                <div class="absolute top-1/2 left-0 w-full h-1 bg-dark-border -z-10 rounded-full"></div>
                <div id="step-ind-1" class="w-8 h-8 rounded-full bg-brand-primary text-white flex items-center justify-center font-bold text-sm shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all">1</div>
                <div id="step-ind-2" class="w-8 h-8 rounded-full bg-dark-card border border-dark-border text-gray-500 flex items-center justify-center font-bold text-sm transition-all">2</div>
                <div id="step-ind-3" class="w-8 h-8 rounded-full bg-dark-card border border-dark-border text-gray-500 flex items-center justify-center font-bold text-sm transition-all">3</div>
            </div>
            <div class="flex justify-between text-[10px] text-gray-500 mt-2 px-1">
                <span>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù„Ù†</span><span>Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</span><span>ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ</span>
            </div>
        </div>

        <div class="p-6 overflow-y-auto custom-scroll flex-1">
            <!-- STEP 1 -->
            <div id="step-1" class="space-y-4">
                <h4 class="text-center text-lg font-bold text-white mb-6">Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ø´ØªØ±Ø§Ú© Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="plans-container"></div>
            </div>

            <!-- STEP 2 -->
            <div id="step-2" class="hidden space-y-4">
                <div class="flex items-center gap-2 text-sm text-gray-400 mb-4 cursor-pointer hover:text-white" onclick="prevStep(1)">
                    <i data-lucide="arrow-right" class="w-4 h-4"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
                </div>
                <h4 class="text-center text-lg font-bold text-white mb-6">Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h4>
                <div class="grid grid-cols-2 gap-4" id="crypto-container"></div>
            </div>

            <!-- STEP 3 -->
            <div id="step-3" class="hidden text-center space-y-6">
                <div class="flex items-center gap-2 text-sm text-gray-400 mb-2 cursor-pointer hover:text-white" onclick="prevStep(2)">
                    <i data-lucide="arrow-right" class="w-4 h-4"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
                </div>

                <div class="p-4 rounded-xl bg-brand-primary/10 border border-brand-primary/20">
                    <p class="text-sm text-brand-primary mb-1">Ù‚ÛŒÙ…Øª Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</p>
                    <div class="text-2xl font-black text-white" id="final-price-display">0 ØªÙˆÙ…Ø§Ù†</div>
                    <div class="text-xs text-gray-400 mt-1" id="final-price-crypto">...</div>
                </div>

                <div class="space-y-2 text-right">
                    <label class="text-xs text-gray-400">Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ <span id="wallet-label"></span>:</label>
                    <div class="flex gap-2">
                        <div class="flex-1 bg-black/30 border border-dark-border rounded-lg p-3 font-mono text-xs text-gray-300 break-all" id="wallet-address-display">...</div>
                        <button onclick="copyWallet()" class="px-4 bg-white/10 hover:bg-white/20 rounded-lg text-white transition">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="w-full h-px bg-white/5"></div>

                <div class="space-y-2 text-right">
                    <label class="text-xs text-gray-400">Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ ØªØ±Ø§Ú©Ù†Ø´ (TX Hash / Hash ID):</label>
                    <input type="text" id="tx-hash-input" class="w-full bg-dark-input border border-dark-border rounded-xl px-4 py-3 text-white focus:border-brand-primary focus:outline-none transition-colors" placeholder="Ù…Ø«Ù„Ø§: 7a82f...">
                    <p class="text-[10px] text-gray-500">Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ² Ø¯Ù‚ÛŒÙ‚ Ù…Ø¨Ù„ØºØŒ Ù‡Ø´ ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
                </div>

                <button onclick="confirmPayment()" id="btn-pay-confirm" class="w-full py-4 rounded-xl bg-gradient-to-r from-brand-primary to-brand-secondary text-white font-bold shadow-lg shadow-brand-primary/25 hover:shadow-brand-primary/40 transition-all">
                    Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-dark-card border border-dark-border text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 translate-y-20 opacity-0 transition-all duration-300 z-[200]">
        <i id="toast-icon" data-lucide="info" class="w-5 h-5 text-brand-primary"></i>
        <span id="toast-msg" class="text-sm font-medium">Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…</span>
    </div>

    <script>
        // CONFIG
        const CONFIG = {
            API_BASE: "https://two-api-iksq.onrender.com",
            NOBITEX_API: "https://apiv2.nobitex.ir",
            // ÙˆÙ„Øªâ€ŒÙ‡Ø§
            WALLETS: { TRX: "TCne3Bt8ZohH4E6ZrSoHT7pnw285HE72B3", USDT: "TCne3Bt8ZohH4E6ZrSoHT7pnw285HE72B3", TON: "UQBc8sYVNAPhlqVjaoRlx8HAmVS1xGKD2yMmHHoeMynQtHFM", SOL: "J4VEzqyqMa4BD8VfjicVHjLKwKRG3LyTMHiKTzuTbZrj" },
            // Ù¾Ù„Ù†â€ŒÙ‡Ø§ â€” ØªÙˆØ¬Ù‡: priceToman Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª (ØªÙˆ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ† Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø®ÙˆØ¯Øª ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒ)
            PLANS: [
                { id: 1, days: 30, priceToman: 70000, label: "1 Ù…Ø§Ù‡Ù‡", desc: "Ø¨Ø±Ù†Ø²ÛŒ" },
                { id: 2, days: 90, priceToman: 198000, label: "3 Ù…Ø§Ù‡Ù‡", desc: "Ù†Ù‚Ø±Ù‡", tag: "Ù…Ø­Ø¨ÙˆØ¨" },
                { id: 3, days: 180, priceToman: 399000, label: "6 Ù…Ø§Ù‡Ù‡", desc: "Ø·Ù„Ø§" },
                { id: 4, days: 365, priceToman: 798000, label: "1 Ø³Ø§Ù„Ù‡", desc: "Ø§Ù„Ù…Ø§Ø³", tag: "ÙˆÛŒÚ˜Ù‡" },
            ],
            CRYPTOS: [
                { id: 'TRX', name: 'Tron (TRX)', icon: 'https://cryptologos.cc/logos/tron-trx-logo.png?v=025' },
                { id: 'USDT', name: 'Tether (USDT)', icon: 'https://cryptologos.cc/logos/tether-usdt-logo.png?v=025' },
                { id: 'TON', name: 'Toncoin (TON)', icon: 'https://cryptologos.cc/logos/toncoin-ton-logo.png?v=025' },
                { id: 'SOL', name: 'Solana (SOL)', icon: 'https://cryptologos.cc/logos/solana-sol-logo.png?v=025' }
            ],
            // Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ù†ÙˆØ¨ÛŒØªÚ©Ø³ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø§Ø±Ø² (Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† lastTradePrice Ø¨Ù‡ ØµÙˆØ±Øª Ø±ÛŒØ§Ù„)
            NOBITEX_SYMBOLS: { USDT: 'USDTIRT', TRX: 'TRXIRT', TON: 'TONIRT', SOL: 'SOLIRT' }
        };

        let state = { user: null, selectedPlan: null, selectedCrypto: null };

        const getAuthHeaders = () => {
            const token = localStorage.getItem('at');
            return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
        };

        async function fetchProfile() {
            try {
                if (!localStorage.getItem('at')) { window.location.href = '/auth'; return; }
                const res = await fetch(`${CONFIG.API_BASE}/auth/me`, { headers: getAuthHeaders() });
                if (res.status === 401) { logout(); return; }
                const data = await res.json();
                if (res.ok) { state.user = data; updateDashboardUI(data); }
            } catch (err) { console.error(err); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±", "error"); }
        }

        function updateDashboardUI(user) {
            document.getElementById('username-display').innerText = user.username || 'Ú©Ø§Ø±Ø¨Ø±';
            document.getElementById('user-role').innerText = user.role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ú©Ù„' : 'Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ';
            const daysLeft = user.days_left ?? 0;
            const daysText = document.getElementById('days-left-text');
            const planStatus = document.getElementById('plan-status');
            const expiryDateEl = document.getElementById('expiry-date');
            if (daysLeft > 0) {
                daysText.innerText = `${daysLeft} Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡`; planStatus.innerText = "ÙØ¹Ø§Ù„ âœ…";
                document.getElementById('days-badge').className = "inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 text-green-400 text-xs border border-green-500/20";
            } else {
                daysText.innerText = "Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡"; planStatus.innerText = "ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ";
                document.getElementById('days-badge').className = "inline-flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/10 text-red-400 text-xs border border-red-500/20";
            }
            if (user.expiry_iso) { const d = new Date(user.expiry_iso); expiryDateEl.innerText = d.toLocaleDateString('fa-IR'); } else expiryDateEl.innerText = "-";
        }

        function logout() { localStorage.removeItem('at'); localStorage.removeItem('rt'); window.location.href = '/auth'; }

        // WIZARD (drawer) open/close
        function openWizard() {
            document.getElementById('wizard-drawer').classList.add('open');
            document.getElementById('wizard-backdrop').classList.add('show');
            renderPlans(); goToStep(1);
        }
        function closeWizard() {
            document.getElementById('wizard-drawer').classList.remove('open');
            document.getElementById('wizard-backdrop').classList.remove('show');
            state.selectedPlan = null; state.selectedCrypto = null;
            document.getElementById('tx-hash-input').value = "";
            // reset indicators
            [1,2,3].forEach(i => {
                const el = document.getElementById(`step-ind-${i}`);
                el.innerText = i; el.innerHTML = i;
                el.className = "w-8 h-8 rounded-full bg-dark-card border border-dark-border text-gray-500 flex items-center justify-center font-bold text-sm transition-all";
            });
        }

        function goToStep(step) {
            [1,2,3].forEach(i => document.getElementById(`step-${i}`).classList.add('hidden'));
            [1,2,3].forEach(i => {
                const el = document.getElementById(`step-ind-${i}`);
                if (i === step) { el.className = "w-8 h-8 rounded-full bg-brand-primary text-white flex items-center justify-center font-bold text-sm shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all"; el.innerText = i; }
                else if (i < step) { el.className = "w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-sm transition-all"; el.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>'; }
                else { el.className = "w-8 h-8 rounded-full bg-dark-card border border-dark-border text-gray-500 flex items-center justify-center font-bold text-sm transition-all"; el.innerText = i; }
            });
            document.getElementById(`step-${step}`).classList.remove('hidden'); lucide.createIcons();
        }

        function prevStep(target) { goToStep(target); }

        // PLANS (Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†)
        function renderPlans() {
            const container = document.getElementById('plans-container'); container.innerHTML = '';
            CONFIG.PLANS.forEach(plan => {
                const selected = state.selectedPlan?.id === plan.id;
                const el = document.createElement('div');
                el.className = `cursor-pointer relative p-4 rounded-2xl border-2 transition-all hover:scale-[1.02] ${selected ? 'border-brand-primary bg-brand-primary/5' : 'border-dark-border bg-dark-card hover:border-gray-600'}`;
                el.onclick = () => selectPlan(plan);
                el.innerHTML = `
                    ${plan.tag ? `<span class="absolute -top-3 right-4 bg-brand-secondary text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg">${plan.tag}</span>` : ''}
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-white text-lg">${plan.label}</span>
                        <span class="font-mono text-brand-primary font-bold">${plan.priceToman.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <p class="text-xs text-gray-500">${plan.desc}</p>
                `;
                container.appendChild(el);
            });
        }

        function selectPlan(plan) { state.selectedPlan = plan; renderPlans(); renderCryptos(); setTimeout(()=> goToStep(2), 200); }

        // CRYPTOS
        function renderCryptos() {
            const container = document.getElementById('crypto-container'); container.innerHTML = '';
            CONFIG.CRYPTOS.forEach(crypto => {
                const selected = state.selectedCrypto?.id === crypto.id;
                const el = document.createElement('div');
                el.className = `cursor-pointer flex flex-col items-center gap-2 p-4 rounded-2xl border-2 transition-all hover:bg-white/5 ${selected ? 'border-brand-primary bg-brand-primary/5' : 'border-dark-border bg-dark-card hover:border-gray-600'}`;
                el.onclick = () => selectCrypto(crypto);
                el.innerHTML = `<img src="${crypto.icon}" class="w-10 h-10 rounded-full" alt="${crypto.name}"><span class="text-xs font-bold text-white">${crypto.name}</span>`;
                container.appendChild(el);
            });
        }

        async function selectCrypto(crypto) {
            state.selectedCrypto = crypto;
            renderCryptos();
            await preparePayment(); // now uses nobitex to calculate
            setTimeout(()=> goToStep(3), 200);
        }

        // NOBITEX helper: get lastTradePrice (Ø±ÛŒØ§Ù„) from orderbook
        async function fetchNobitexLastPriceRials(cryptoId) {
            try {
                const symbol = CONFIG.NOBITEX_SYMBOLS[cryptoId];
                if (!symbol) return null;
                const res = await fetch(`${CONFIG.NOBITEX_API}/v3/orderbook/${symbol}`);
                if (!res.ok) return null;
                const j = await res.json();
                if (j && j.lastTradePrice) return Number(j.lastTradePrice); // Ø±ÛŒØ§Ù„
                return null;
            } catch (e) {
                console.warn('Nobitex price fetch failed', e);
                return null;
            }
        }

        // preparePayment: compute crypto amount from ØªÙˆÙ…Ø§Ù† using Ù†ÙˆØ¨ÛŒØªÚ©Ø³
        async function preparePayment() {
            const plan = state.selectedPlan;
            const crypto = state.selectedCrypto;
            if (!plan || !crypto) return;
            // ØªÙˆÙ…Ø§Ù† -> Ø±ÛŒØ§Ù„
            const priceToman = Number(plan.priceToman);
            const priceRial = priceToman * 10;
            // get market price (Ø±ÛŒØ§Ù„ per 1 unit of crypto)
            const latestRialPrice = await fetchNobitexLastPriceRials(crypto.id);
            const finalPriceDisplay = document.getElementById('final-price-display');
            const finalPriceCrypto = document.getElementById('final-price-crypto');
            if (latestRialPrice && latestRialPrice > 0) {
                const cryptoAmount = priceRial / latestRialPrice;
                finalPriceDisplay.innerText = `${priceToman.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;
                finalPriceCrypto.innerText = `â‰ˆ ${cryptoAmount.toFixed(6)} ${crypto.id} (Ù†Ø±Ø® Ù¾Ø§ÛŒÙ‡ Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³)`;
            } else {
                finalPriceDisplay.innerText = `${priceToman.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;
                finalPriceCrypto.innerText = `Ù‚Ø§Ø¨Ù„ÛŒØª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ† ÙØ¹Ù„Ø§Ù‹ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª â€” Ø¢Ø¯Ø±Ø³: ${crypto.id}`;
            }
            document.getElementById('wallet-label').innerText = `(${crypto.name})`;
            document.getElementById('wallet-address-display').innerText = CONFIG.WALLETS[crypto.id] || "Ø¢Ø¯Ø±Ø³ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
        }

        function copyWallet() {
            const addr = document.getElementById('wallet-address-display').innerText;
            navigator.clipboard.writeText(addr).then(()=> showToast("Ø¢Ø¯Ø±Ø³ Ú©Ù¾ÛŒ Ø´Ø¯!", "success")).catch(()=> showToast("Ú©Ù¾ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ø´Ø¯", "error"));
        }

        async function confirmPayment() {
            const txHash = document.getElementById('tx-hash-input').value.trim();
            if (!txHash) { showToast("Ù„Ø·ÙØ§ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯", "error"); return; }
            const btn = document.getElementById('btn-pay-confirm'); const originalText = btn.innerText;
            btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ..."; btn.disabled = true; btn.classList.add('opacity-50');

            try {
                const payload = { days: state.selectedPlan.days, tx_hash: txHash, coupon_code: null };
                const res = await fetch(`${CONFIG.API_BASE}/payment/submit`, { method:'POST', headers:getAuthHeaders(), body: JSON.stringify(payload) });
                const data = await res.json();
                if (res.ok || res.status === 201 || res.status === 202) {
                    showToast("ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ Ø§Ø³Øª.", "success"); closeWizard(); fetchProfile();
                } else { showToast(data.msg || "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´", "error"); }
            } catch (err) { showToast("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡", "error"); }
            finally { btn.innerText = originalText; btn.disabled = false; btn.classList.remove('opacity-50'); }
        }

        // GIFT
        async function submitGift() {
            const input = document.getElementById('gift-input'); const code = input.value.trim();
            if (!code) { showToast("Ù„Ø·ÙØ§ Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯", "error"); return; }
            const btn = document.getElementById('btn-gift'); btn.innerHTML = '<div class="loader w-4 h-4 border-2"></div>'; btn.disabled = true;
            try {
                const payload = { days: 0, coupon_code: code };
                const res = await fetch(`${CONFIG.API_BASE}/payment/submit`, { method:'POST', headers:getAuthHeaders(), body: JSON.stringify(payload) });
                const data = await res.json();
                if (res.ok) { showToast("Ú©Ø¯ Ù‡Ø¯ÛŒÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯!", "success"); input.value = ""; fetchProfile(); }
                else { showToast(data.msg || "Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª", "error"); }
            } catch (e) { showToast("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡", "error"); }
            finally { btn.innerHTML = '<span>Ø§Ø¹Ù…Ø§Ù„ Ú©Ø¯</span><i data-lucide="arrow-left" class="w-4 h-4"></i>'; btn.disabled = false; lucide.createIcons(); }
        }

        // UTILS
        function showToast(msg, type='info') {
            const toast = document.getElementById('toast'); const icon = document.getElementById('toast-icon'); const text = document.getElementById('toast-msg');
            text.innerText = msg; toast.classList.remove('translate-y-20','opacity-0');
            if (type==='success') { icon.setAttribute('class','w-5 h-5 text-green-400'); icon.setAttribute('data-lucide','check-circle'); }
            else if (type==='error') { icon.setAttribute('class','w-5 h-5 text-red-400'); icon.setAttribute('data-lucide','alert-circle'); }
            else { icon.setAttribute('class','w-5 h-5 text-brand-primary'); icon.setAttribute('data-lucide','info'); }
            lucide.createIcons();
            setTimeout(()=> { toast.classList.add('translate-y-20','opacity-0'); }, 3000);
        }

        // ON LOAD
        window.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); fetchProfile(); });
    </script>
</body>
</html>
